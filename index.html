<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <title>ç†ç§‘è©•ä¾¡ è¨˜éŒ²ãƒ„ãƒ¼ãƒ«ï¼ˆiPadï¼‰</title>

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --shadow: 0 10px 26px rgba(0,0,0,.10);
      --radius:18px;

      --k:#0ea5e9;  /* çŸ¥è­˜ãƒ»æŠ€èƒ½ */
      --t:#6366f1;  /* æ€è€ƒãƒ»åˆ¤æ–­ãƒ»è¡¨ç¾ */
      --a:#f59e0b;  /* ä¸»ä½“çš„ */
      --danger:#ef4444;
      --ok:#10b981;
    }

    :root[data-theme="dark"]{
      --bg:#0b1220;
      --card:#111a2b;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --line:#243049;
      --shadow: 0 10px 26px rgba(0,0,0,.35);
    }
    :root[data-theme="dark"] header,
    :root[data-theme="dark"] footer{
      background: rgba(17,26,43,.78);
      border-color: rgba(255,255,255,.10);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Hiragino Sans", "Noto Sans JP", "Segoe UI", Arial;
      background: var(--bg);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      touch-action:manipulation;
    }
    button, input, textarea, select { font: inherit; color:inherit; }
    a{color:inherit}
    .safe{padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);}
    .app{min-height:100%;display:flex;flex-direction:column;}

    header{
      position:sticky; top:0; z-index:50;
      background: rgba(255,255,255,.82);
      backdrop-filter: blur(10px);
      border-bottom:1px solid rgba(0,0,0,.08);
    }
    :root[data-theme="dark"] header{
      background: rgba(17,26,43,.78);
      border-bottom:1px solid rgba(255,255,255,.10);
    }

    .topbar{
      padding:14px 14px 10px;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .title{display:flex; flex-direction:column; gap:2px;}
    .title b{font-size:16px}
    .title small{color:var(--muted); font-size:12px}

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 12px;
      border-radius:999px;
      background: rgba(255,255,255,.9);
      border:1px solid rgba(0,0,0,.10);
      box-shadow: 0 8px 20px rgba(0,0,0,.08);
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    :root[data-theme="dark"] .pill{
      background: rgba(17,26,43,.9);
      border-color: rgba(255,255,255,.12);
    }
    .pill strong{font-size:14px}
    .pill .dot{width:10px;height:10px;border-radius:999px;background:var(--ok)}

    .actions{display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end}
    .btn{
      border:none;
      border-radius:14px;
      padding:12px 14px;
      background: rgba(255,255,255,.92);
      border:1px solid rgba(0,0,0,.10);
      box-shadow: var(--shadow);
      cursor:pointer;
      min-height:44px;
      -webkit-tap-highlight-color: transparent;
      user-select:none;
    }
    :root[data-theme="dark"] .btn{
      background: rgba(17,26,43,.92);
      border-color: rgba(255,255,255,.12);
    }
    .btn:active{transform: translateY(1px)}
    .btn.primary{background: rgba(99,102,241,.10); border-color: rgba(99,102,241,.25)}
    .btn.warn{background: rgba(245,158,11,.10); border-color: rgba(245,158,11,.25)}
    .btn.danger{background: rgba(239,68,68,.10); border-color: rgba(239,68,68,.25)}
    .btn.ok{background: rgba(16,185,129,.10); border-color: rgba(16,185,129,.25)}
    .btn.small{padding:10px 12px; border-radius:12px; font-size:13px}
    .btn.ghost{background: transparent; box-shadow:none}

    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}

    main{
      flex:1;
      padding:14px 14px 120px;
      max-width:1100px;
      width:100%;
      margin:0 auto;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    @media (min-width: 940px){
      .grid{grid-template-columns: 360px 1fr;}
    }

    .card{
      background: var(--card);
      border:1px solid rgba(0,0,0,.10);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    :root[data-theme="dark"] .card{
      border-color: rgba(255,255,255,.12);
    }
    .card h3{
      margin:0;
      padding:14px 14px 10px;
      font-size:14px;
      color:var(--muted);
      border-bottom:1px solid rgba(0,0,0,.08);
      background: rgba(0,0,0,.02);
      display:flex; align-items:center; justify-content:space-between; gap:8px;
    }
    :root[data-theme="dark"] .card h3{
      border-bottom:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
    }
    .card .body{padding:14px}
    .muted{color:var(--muted)}
    .split{
      display:flex; gap:10px; flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    .field{display:flex; flex-direction:column; gap:6px;}
    .field label{font-size:12px; color:var(--muted)}
    .input, textarea{
      background: rgba(255,255,255,.95);
      border:1px solid rgba(0,0,0,.12);
      border-radius: 14px;
      padding:12px 12px;
      min-height:44px;
      outline:none;
    }
    :root[data-theme="dark"] .input,
    :root[data-theme="dark"] textarea{
      background: rgba(255,255,255,.04);
      border-color: rgba(255,255,255,.14);
    }

    textarea{
      min-height:72px;
      resize:vertical;
      padding-bottom:18px;
    }

    .select{
      background: rgba(255,255,255,.95);
      border:1px solid rgba(0,0,0,.12);
      border-radius: 14px;
      padding:12px 12px;
      min-height:44px;
    }
    :root[data-theme="dark"] .select{
      background: rgba(255,255,255,.04);
      border-color: rgba(255,255,255,.14);
    }

    .list{display:flex; flex-direction:column; gap:10px;}
    .student{
      padding:12px 12px;
      border-radius:16px;
      border:1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.95);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      user-select:none;
    }
    :root[data-theme="dark"] .student{
      background: rgba(255,255,255,.04);
      border-color: rgba(255,255,255,.14);
    }
    .student.active{
      background: rgba(99,102,241,.08);
      border-color: rgba(99,102,241,.25);
    }
    .student b{font-size:15px}
    .badge{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.92);
      font-size:12px;
      display:inline-flex; align-items:center; gap:6px;
      user-select:none;
    }
    :root[data-theme="dark"] .badge{
      background: rgba(255,255,255,.04);
      border-color: rgba(255,255,255,.14);
    }
    .badge .s{font-weight:700}
    .badge.k{border-color: rgba(14,165,233,.35); background: rgba(14,165,233,.08)}
    .badge.t{border-color: rgba(99,102,241,.35); background: rgba(99,102,241,.08)}
    .badge.a{border-color: rgba(245,158,11,.35); background: rgba(245,158,11,.08)}
    .badge.total{border-color: rgba(0,0,0,.14); background: rgba(0,0,0,.03)}
    :root[data-theme="dark"] .badge.total{border-color: rgba(255,255,255,.14); background: rgba(255,255,255,.03)}

    .grade{
      font-weight:800;
      padding:6px 10px;
      border-radius:12px;
      border:1px solid rgba(0,0,0,.12);
      min-width:44px;
      text-align:center;
      background: rgba(255,255,255,.95);
    }
    :root[data-theme="dark"] .grade{
      background: rgba(255,255,255,.04);
      border-color: rgba(255,255,255,.14);
    }
    .grade.A{background: rgba(16,185,129,.10); border-color: rgba(16,185,129,.25)}
    .grade.Bp{background: rgba(14,165,233,.10); border-color: rgba(14,165,233,.25)}
    .grade.B{background: rgba(0,0,0,.03); border-color: rgba(0,0,0,.14)}
    .grade.Bm{background: rgba(245,158,11,.10); border-color: rgba(245,158,11,.25)}
    .grade.C{background: rgba(239,68,68,.10); border-color: rgba(239,68,68,.25)}
    :root[data-theme="dark"] .grade.B{background: rgba(255,255,255,.05); border-color: rgba(255,255,255,.14)}

    .rubric{display:flex; flex-direction:column; gap:12px;}
    details{
      border-radius: 16px;
      border:1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.95);
      overflow:hidden;
    }
    :root[data-theme="dark"] details{
      background: rgba(255,255,255,.04);
      border-color: rgba(255,255,255,.14);
    }
    summary{
      list-style:none;
      padding:12px 12px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      background: rgba(0,0,0,.02);
      border-bottom:1px solid rgba(0,0,0,.06);
    }
    :root[data-theme="dark"] summary{
      background: rgba(255,255,255,.03);
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    summary::-webkit-details-marker{display:none}
    .sumL{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
    .tag{
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      border:1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.92);
      user-select:none;
    }
    :root[data-theme="dark"] .tag{
      background: rgba(255,255,255,.04);
      border-color: rgba(255,255,255,.14);
    }
    .tag.k{border-color: rgba(14,165,233,.35); background: rgba(14,165,233,.08)}
    .tag.t{border-color: rgba(99,102,241,.35); background: rgba(99,102,241,.08)}
    .tag.a{border-color: rgba(245,158,11,.35); background: rgba(245,158,11,.08)}
    .tag.gray{border-color: rgba(0,0,0,.14); background: rgba(0,0,0,.03)}
    :root[data-theme="dark"] .tag.gray{border-color: rgba(255,255,255,.14); background: rgba(255,255,255,.03)}
    .sumR{display:flex; align-items:center; gap:8px; flex-wrap:wrap; justify-content:flex-end}
    .mini{font-size:12px;color:var(--muted)}
    .line{height:1px;background: rgba(0,0,0,.08); margin:10px 0}
    :root[data-theme="dark"] .line{background: rgba(255,255,255,.10)}
    .block{padding:12px}
    .scoreRow{
      display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap;
      justify-content:space-between;
    }
    .num{
      width:110px;
      text-align:center;
      font-weight:800;
      font-size:18px;
      letter-spacing:.5px;
    }
    .hint{font-size:12px;color:var(--muted)}
    .itemCard{
      border-radius: 16px;
      border:1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.95);
      padding:12px;
      display:flex; flex-direction:column; gap:10px;
    }
    :root[data-theme="dark"] .itemCard{
      background: rgba(255,255,255,.04);
      border-color: rgba(255,255,255,.14);
    }

    .photoArea{display:flex; flex-direction:column; gap:10px;}
    .photoStrip{display:flex; gap:10px; flex-wrap:wrap;}
    .thumb{
      width:110px; height:90px;
      border-radius: 14px;
      border:1px solid rgba(0,0,0,.12);
      background: rgba(0,0,0,.03);
      overflow:hidden;
      position:relative;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    :root[data-theme="dark"] .thumb{
      border-color: rgba(255,255,255,.14);
      background: rgba(255,255,255,.03);
    }
    .thumb img{width:100%; height:100%; object-fit:cover; display:block;}
    .thumb .x{
      position:absolute; top:6px; right:6px;
      width:26px; height:26px; border-radius:999px;
      border:none;
      background: rgba(255,255,255,.88);
      border:1px solid rgba(0,0,0,.12);
      cursor:pointer;
    }
    :root[data-theme="dark"] .thumb .x{
      background: rgba(17,26,43,.88);
      border-color: rgba(255,255,255,.14);
    }
    .thumb .x:active{transform:translateY(1px)}
    .thumb .lbl{
      position:absolute; bottom:6px; left:6px;
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      background: rgba(255,255,255,.88);
      border:1px solid rgba(0,0,0,.12);
      user-select:none;
    }
    :root[data-theme="dark"] .thumb .lbl{
      background: rgba(17,26,43,.88);
      border-color: rgba(255,255,255,.14);
    }

    .modal{
      position:fixed; inset:0;
      background: rgba(0,0,0,.45);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:100;
      padding: 14px;
    }
    .modal.show{display:flex}
    .modalCard{
      width:min(980px, 100%);
      max-height: 92vh;
      border-radius: 18px;
      border:1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.96);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    :root[data-theme="dark"] .modalCard{
      background: rgba(17,26,43,.96);
      border-color: rgba(255,255,255,.14);
    }
    .modalTop{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:12px 12px;
      border-bottom:1px solid rgba(0,0,0,.10);
      background: rgba(0,0,0,.02);
      flex-wrap:wrap;
    }
    :root[data-theme="dark"] .modalTop{
      border-bottom:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
    }
    .modalTop .left{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .modalTop .right{display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end}
    .canvasWrap{
      position:relative;
      background: rgba(0,0,0,.03);
      flex:1;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      padding:10px;
    }
    :root[data-theme="dark"] .canvasWrap{ background: rgba(255,255,255,.03); }
    .stage{
      position:relative;
      border-radius: 14px;
      overflow:hidden;
      border:1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.96);
    }
    :root[data-theme="dark"] .stage{
      border-color: rgba(255,255,255,.14);
      background: rgba(255,255,255,.03);
    }
    .stage img{display:block; max-width: 100%; height:auto}
    canvas{position:absolute; left:0; top:0; touch-action: none;}
    .toolRow{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
    .toolRow .lab{font-size:12px;color:var(--muted)}
    .range{width:140px}

    .toast{
      position:fixed;
      left:50%;
      bottom: calc(18px + env(safe-area-inset-bottom));
      transform: translateX(-50%);
      background: rgba(0,0,0,.72);
      color:white;
      border:1px solid rgba(255,255,255,.18);
      border-radius:999px;
      padding:10px 14px;
      font-size:13px;
      display:none;
      z-index:200;
      max-width: calc(100% - 20px);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .toast.show{display:block}

    footer{
      position:fixed;
      left:0; right:0; bottom:0;
      padding:10px 12px calc(10px + env(safe-area-inset-bottom));
      background: rgba(255,255,255,.86);
      border-top:1px solid rgba(0,0,0,.08);
      backdrop-filter: blur(10px);
      z-index:40;
    }
    :root[data-theme="dark"] footer{
      background: rgba(17,26,43,.78);
      border-top:1px solid rgba(255,255,255,.10);
    }
    .foot{
      max-width:1100px;
      margin:0 auto;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .statline{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      color:var(--muted);
      font-size:12px;
    }

    .itemRow{
      padding:12px;
      border-radius:16px;
      border:1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.95);
      display:flex;
      gap:10px;
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    :root[data-theme="dark"] .itemRow{
      background: rgba(255,255,255,.04);
      border-color: rgba(255,255,255,.14);
    }
    .smallChecks{display:flex; gap:6px; flex-wrap:wrap; align-items:center;}
    .smallChecks input{ width:22px; height:22px; }

    .itemSide{
      display:flex;
      flex-direction:column;
      gap:8px;
      align-items:flex-end;
      justify-content:flex-start;
      min-width:300px;
      max-width:520px;
      flex:1;
    }
    .miniMemo{
      width:100%;
      min-height:54px;
      resize:vertical;
      font-size:13px;
      padding-bottom:18px;
    }
    .thumbMini{
      width:74px; height:58px;
      border-radius:12px;
      border:1px solid rgba(0,0,0,.12);
      overflow:hidden;
      background: rgba(0,0,0,.03);
      position:relative;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    :root[data-theme="dark"] .thumbMini{
      border-color: rgba(255,255,255,.14);
      background: rgba(255,255,255,.03);
    }
    .thumbMini img{width:100%; height:100%; object-fit:cover; display:block;}
    .thumbMini .x{
      position:absolute; top:4px; right:4px;
      width:22px; height:22px; border-radius:999px;
      border:none;
      background: rgba(255,255,255,.88);
      border:1px solid rgba(0,0,0,.12);
      cursor:pointer;
      font-size:14px;
      line-height:22px;
      padding:0;
    }
    :root[data-theme="dark"] .thumbMini .x{
      background: rgba(17,26,43,.88);
      border-color: rgba(255,255,255,.14);
    }
  </style>
</head>

<body>
<div class="app safe">
  <header>
    <div class="topbar">
      <div class="title">
        <b>ç†ç§‘è©•ä¾¡ è¨˜éŒ²ãƒ„ãƒ¼ãƒ«ï¼ˆiPadæœ€é©åŒ–ï¼‰</b>
        <small id="subTitle">å˜å…ƒï¼šé›»æ°—ã®é€šã‚Šé“ï½œç«¯æœ«å†…ã«è‡ªå‹•ä¿å­˜</small>
      </div>
      <div class="actions">
        <button class="btn small" id="btnMode">è¡¨ç¤ºï¼šé …ç›®ã¸</button>
        <button class="btn small" id="btnTheme">ğŸŒ™ ãƒ€ãƒ¼ã‚¯</button>
        <button class="btn small ok" id="btnExportCSV">CSVå‡ºåŠ›</button>
        <button class="btn small primary" id="btnBackup">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—(JSON)</button>
        <button class="btn small warn" id="btnRestore">å¾©å…ƒ(JSON)</button>
        <button class="btn small danger" id="btnReset">å…¨æ¶ˆå»</button>
      </div>
    </div>
  </header>

  <main>
    <div class="grid">
      <section class="card">
        <h3><span>åç°¿</span><span class="mini">ã‚¿ãƒƒãƒ—ã§åˆ‡æ›¿</span></h3>
        <div class="body">
          <div class="field">
            <label>å…ç«¥åï¼ˆæ”¹è¡Œã§è¤‡æ•°ï¼‰</label>
            <textarea id="rosterText" placeholder="ä¾‹ï¼‰&#10;3-1 ç”°ä¸­å¤ªéƒ&#10;3-1 ä½è—¤èŠ±å­"></textarea>
          </div>
          <div class="row" style="margin-top:10px; justify-content:flex-end;">
            <button class="btn ok" id="btnApplyRoster">åç°¿ã‚’åæ˜ </button>
          </div>
          <div class="line"></div>
          <div class="list" id="studentList"></div>
        </div>
      </section>

      <section class="card">
        <h3><span>æ¡ç‚¹</span><span class="mini" id="who">â€”</span></h3>
        <div class="body">
          <div class="split">
            <div class="field" style="flex:1; min-width:260px;">
              <label>å˜å…ƒå</label>
              <input class="input" id="unitName" placeholder="ä¾‹ï¼šé›»æ°—ã®é€šã‚Šé“" />
            </div>
            <div class="field" style="min-width:220px;">
              <label>æˆæ¥­å›ï¼ˆè¨˜éŒ²ç”¨ï¼‰</label>
              <select class="select" id="lessonKey"></select>
            </div>
          </div>

          <div class="line"></div>

          <div class="split">
            <div class="row">
              <span class="badge k"><span class="s">çŸ¥è­˜ãƒ»æŠ€èƒ½</span> <span id="sumK">0</span></span>
              <span class="badge t"><span class="s">æ€è€ƒãƒ»åˆ¤æ–­ãƒ»è¡¨ç¾</span> <span id="sumT">0</span></span>
              <span class="badge a"><span class="s">ä¸»ä½“çš„</span> <span id="sumA">0</span></span>
              <span class="badge total"><span class="s">åˆè¨ˆ</span> <span id="sumAll">0</span></span>
            </div>
            <div class="row">
              <span class="grade B" id="gradeAll">â€”</span>
            </div>
          </div>

          <div class="line"></div>

          <div id="itemModePanel" style="display:none;">
            <div class="field">
              <label>é …ç›®ã‚’é¸æŠï¼ˆã“ã®é …ç›®ã‚’å…¨å“¡åˆ†ã¾ã¨ã‚ã¦å…¥åŠ›ï¼‰</label>
              <select class="select" id="itemGroupSelect"></select>
            </div>
            <div class="line"></div>
            <div id="itemList" class="list"></div>
            <div class="line"></div>
          </div>

          <div class="rubric" id="rubric"></div>

          <div class="line"></div>

          <div class="field">
            <label>å…¨ä½“ãƒ¡ãƒ¢ï¼ˆã“ã®å…ç«¥ãƒ»ã“ã®æˆæ¥­å›ï¼‰â€»é«˜ã•ã¯è‡ªç”±ã«å¤‰ãˆã‚‰ã‚Œã¾ã™</label>
            <textarea id="overallMemo" placeholder="æ°—ã¥ãã€å£°ã‹ã‘ã€æ¬¡æ™‚ã®æ‰‹ç«‹ã¦ ãªã©"></textarea>
          </div>
        </div>
      </section>
    </div>
  </main>

  <footer>
    <div class="foot">
      <div class="statline" id="statusLine">
        <span class="pill"><span class="dot" id="dot"></span><strong id="saveState">ä¿å­˜OK</strong></span>
        <span>â€»iPadã¯Safariæ¨å¥¨ï¼ˆãƒ›ãƒ¼ãƒ ç”»é¢è¿½åŠ ã§å®‰å®šï¼‰</span>
      </div>
      <div class="row">
        <button class="btn small" id="btnPrev">â—€ å‰ã®å…ç«¥</button>
        <button class="btn small" id="btnNext">æ¬¡ã®å…ç«¥ â–¶</button>
      </div>
    </div>
  </footer>

  <div class="modal" id="modal">
    <div class="modalCard">
      <div class="modalTop">
        <div class="left">
          <span class="tag gray" id="modalTitle">å†™çœŸæ³¨é‡ˆ</span>
          <span class="mini" id="modalSub">â€”</span>
        </div>
        <div class="right">
          <div class="toolRow">
            <span class="lab">è‰²</span>
            <input type="color" id="penColor" value="#ef4444" />
          </div>
          <div class="toolRow">
            <span class="lab">å¤ªã•</span>
            <input class="range" type="range" id="penSize" min="1" max="28" value="6" />
            <span class="mini" id="penSizeVal">6</span>
          </div>

          <button class="btn small" id="toolPen">ãƒšãƒ³</button>
          <button class="btn small warn" id="toolEraser">æ¶ˆã—ã‚´ãƒ </button>
          <button class="btn small danger" id="toolObjEraser">ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæ¶ˆã—</button>

          <button class="btn small" id="toolLine">ï¼</button>
          <button class="btn small" id="toolArrow">â†’</button>
          <button class="btn small" id="toolRect">â–¡</button>
          <button class="btn small" id="toolCircle">â—‹</button>
          <button class="btn small" id="toolEllipse">â—¯</button>
          <button class="btn small" id="toolTri">â–³</button>

          <button class="btn small" id="toolText">T</button>
          <button class="btn small" id="btnUndo">æˆ»ã™</button>
          <button class="btn small" id="btnClearInk">æ³¨é‡ˆå…¨æ¶ˆã—</button>

          <button class="btn small ok" id="btnSaveInk">ä¿å­˜</button>
          <button class="btn small ghost" id="btnClose">é–‰ã˜ã‚‹</button>
        </div>
      </div>

      <div class="canvasWrap" id="canvasWrap">
        <div class="stage" id="stage">
          <img id="baseImg" alt="photo" />
          <canvas id="ink"></canvas>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>
</div>

<script>
/** =========================
 *  1) è¨­å®šï¼ˆè©•ä¾¡è¨ˆç”»ï¼‰
 * ========================= */
const CONFIG = {
  unitDefault: "é›»æ°—ã®é€šã‚Šé“",
  lessons: [
    { key:"L12", name:"ç¬¬1-2æ™‚ï¼šå›è·¯ï¼ˆæŠ€èƒ½ãƒ»çŸ¥è­˜ï¼‰ï¼‹äºˆæƒ³ï¼‹è€ƒå¯Ÿ" },
    { key:"L3",  name:"ç¬¬3-5æ™‚ï¼šé€šã™/é€šã•ãªã„ï¼ˆæŠ€èƒ½+æ€è€ƒ+ä¸»ä½“ï¼‰" },
    { key:"L7",  name:"ç¬¬7æ™‚ï¼šç©ºãç¼¶ã¯é€šã™ï¼Ÿï¼ˆç™ºå±•ãƒ»10ç‚¹ï¼‰" },
    { key:"L8",  name:"ç¬¬8æ™‚ï¼šã¾ã¨ã‚ãƒ†ã‚¹ãƒˆï¼ˆçŸ¥è­˜100ï¼‹æ€è€ƒ50ï¼‰" },
    { key:"ALL", name:"é€šã—è©•ä¾¡ï¼ˆ8æ™‚é–“ï¼šãµã‚Šã‹ãˆã‚Šï¼†æˆæ¥­ä¸­ã®æ§˜å­ï¼‰" },
  ],
  domains: {
    K: { label:"çŸ¥è­˜ãƒ»æŠ€èƒ½", color:"var(--k)" },
    T: { label:"æ€è€ƒãƒ»åˆ¤æ–­ãƒ»è¡¨ç¾", color:"var(--t)" },
    A: { label:"ä¸»ä½“çš„", color:"var(--a)" },
  },
  gradeBands: { A:0.86, Bp:0.72, B:0.40, Bm:0.28, C:0.00 },

  rubricByLesson: {
    L12: [
      { id:"K_L12_skill", domain:"K", title:"å›è·¯ã®æŠ€èƒ½ï¼ˆãƒã‚§ãƒƒã‚¯ï¼šé”æˆæ•°ï¼‰",
        scoring:{ type:"checkCount", max:5 },
        criteria:[
          "ä¹¾é›»æ± ã®ï¼‹æ¥µ/âˆ’æ¥µã‚’æ„è­˜ã—ã¦ã¤ãªã",
          "è±†é›»çƒã‚’ã‚½ã‚±ãƒƒãƒˆã«ã—ã£ã‹ã‚Šå›ºå®šã§ãã‚‹",
          "å°ç·šã®ã¤ãªããŒç¢ºå®Ÿï¼ˆå¤–ã‚Œãªã„ï¼‰",
          "å®‰å…¨ï¼ˆã‚·ãƒ§ãƒ¼ãƒˆç­‰ã«æ³¨æ„ï¼‰",
          "çµæœã‚’è¨˜éŒ²ï¼ˆç°¡å˜ã«ã§ã‚‚ï¼‰",
        ],
      },
      { id:"K_L12_know", domain:"K", title:"çŸ¥è­˜ï¼ˆãƒã‚§ãƒƒã‚¯ï¼š2ã¤ï¼‰",
        scoring:{ type:"checkCount", max:2 },
        criteria:[
          "ç”¨èªï¼ˆä¹¾é›»æ± /å°ç·š/è±†é›»çƒ/ã‚½ã‚±ãƒƒãƒˆç­‰ï¼‰ãŒè¨€ãˆã‚‹",
          "å›è·¯ãŒâ€œè¼ªâ€ã«ãªã‚‹ã¨é›»æ°—ãŒé€šã‚‹ã¨èª¬æ˜ã§ãã‚‹",
        ],
      },
      { id:"T_L12_pred", domain:"T", title:"æ€è€ƒï¼šäºˆæƒ³ï¼ˆå›è·¯å›³ï¼‹ç†ç”±ï¼‰â€»æ­£è§£ã§ãªãã¦OKï¼ˆ10ç‚¹ï¼‰",
        scoring:{
          type:"subsum", max:10,
          parts:[
            { text:"å›è·¯å›³ãŒâ€œè¼ªâ€ã¨ã—ã¦æã‘ã¦ã„ã‚‹", max:3 },
            { text:"é›»æ± ã®æ¥µã‚„è±†é›»çƒã®ã¤ãªãŒã‚ŠãŒåˆ†ã‹ã‚‹å›³", max:3 },
            { text:"ç†ç”±ãŒè‡ªåˆ†ã®è¨€è‘‰ã§æ›¸ã‘ã¦ã„ã‚‹ï¼ˆè¦–ç‚¹ï¼‰", max:3 },
            { text:"èª¬æ˜ã®åˆ†ã‹ã‚Šã‚„ã™ã•", max:1 },
          ]
        },
        criteria:[]
      },
      { id:"T_L12_think", domain:"T", title:"æ€è€ƒï¼šè€ƒå¯Ÿï¼ˆã¤ã/ã¤ã‹ãªã„ã®ã‚·ãƒ³ã‚­ãƒ³ã‚°ï¼‰10ç‚¹",
        scoring:{
          type:"subsum", max:10,
          parts:[
            { text:"çµæœã‚’ã‚·ãƒ³ã‚­ãƒ³ã‚°ãƒ„ãƒ¼ãƒ«ã«æ­£ã—ãæ•´ç†", max:4 },
            { text:"æ•´ç†ã‹ã‚‰æ°—ã¥ãï¼ˆå…±é€šç‚¹/ã¡ãŒã„ï¼‰", max:3 },
            { text:"è‡ªåˆ†ã®è¨€è‘‰ã§èª¬æ˜ã§ãã‚‹", max:3 },
          ]
        },
        criteria:[]
      },
    ],

    L3: [
      { id:"K_L3", domain:"K", title:"åˆ†é¡å®Ÿé¨“ã®æŠ€èƒ½ï¼ˆã‚·ãƒ“ã‚¢ç‰ˆï¼šãƒã‚§ãƒƒã‚¯æ•°ï¼‰",
        scoring:{ type:"checkCount", max:5 },
        criteria:[
          "ãƒ†ã‚¹ã‚¿ãƒ¼ã®å‹•ä½œç¢ºèªã‚’å…ˆã«ã§ãã‚‹",
          "å°ç·šã®å½“ã¦æ–¹ãŒç¢ºå®Ÿï¼ˆæ¥è§¦ä¸è‰¯ã‚’æ¸›ã‚‰ã™ï¼‰",
          "å¡—è£…ç­‰ã‚’é¿ã‘ã¦é‡‘å±éƒ¨åˆ†ã«å½“ã¦ã‚‰ã‚Œã‚‹",
          "çµæœã‚’ãã®å ´ã§æ­£ç¢ºã«è¨˜éŒ²ã§ãã‚‹",
          "åŒã˜æ¡ä»¶ã§å†ç¢ºèªï¼ˆèª¤å·®ãƒã‚§ãƒƒã‚¯ï¼‰ãŒã§ãã‚‹",
        ],
      },
      { id:"T_L3a", domain:"T", title:"æ€è€ƒï¼šäºˆæƒ³ï¼ˆ10ç‚¹ï¼‰",
        scoring:{
          type:"subsum", max:10,
          parts:[
            { text:"äºˆæƒ³ãŒæ›¸ã‘ã¦ã„ã‚‹ï¼ˆã€‡Ã—ãªã©ï¼‰", max:2 },
            { text:"ç†ç”±ã«æè³ªãªã©ã®è¦–ç‚¹ãŒã‚ã‚‹", max:5 },
            { text:"èª¬æ˜ãŒåˆ†ã‹ã‚Šã‚„ã™ã„", max:3 },
          ]
        },
        criteria:[]
      },
      { id:"T_L3b", domain:"T", title:"æ€è€ƒï¼šã‚·ãƒ³ã‚­ãƒ³ã‚°â†’åˆ†æâ†’è¡¨ç¾â†’çµè«–ï¼ˆ15ç‚¹ï¼šçµè«–é‡è¦–ï¼‰",
        scoring:{
          type:"subsum", max:15,
          parts:[
            { text:"çµæœã‚’ã‚·ãƒ³ã‚­ãƒ³ã‚°ã«ã¾ã¨ã‚ã‚‰ã‚Œã‚‹", max:4 },
            { text:"ã‚·ãƒ³ã‚­ãƒ³ã‚°ã‹ã‚‰åˆ†æï¼ˆå…±é€šç‚¹/è¦å‰‡æ€§ï¼‰", max:4 },
            { text:"åˆ†æã‚’è¨€è‘‰ã§è¡¨ç¾ã§ãã‚‹", max:3 },
            { text:"è‡ªåˆ†ãªã‚Šã®çµè«–ã‚’å°ã‘ã¦ã„ã‚‹ï¼ˆé‡è¦–ï¼‰", max:4 },
          ]
        },
        criteria:[]
      },
      { id:"A_L3", domain:"A", title:"ä¸»ä½“ï¼šãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆ3å€‹ä»¥ä¸Šã§Bï¼‰",
        scoring:{ type:"manual", max:5 },
        criteria:[
          "èª¿ã¹ãŸã„ç‰©ã‚’3å€‹ä»¥ä¸Šãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ããŸã‹ï¼ˆé‡ï¼‰",
          "ç†ç”±ã‚„è¦–ç‚¹ãŒã‚ã‚‹ã‹ï¼ˆè³ªï¼‰",
        ],
      },
    ],

    L7: [
      { id:"T_L7", domain:"T", title:"æ€è€ƒï¼šç©ºãç¼¶ã¯æœ¬å½“ã¯é€šã™ã¯ãšâ€¦ãªã®ã«é€šã‚‰ãªã„ã®ã¯ãªãœï¼Ÿï¼ˆç™ºå±•ãƒ»10ç‚¹ï¼‰",
        scoring:{
          type:"subsum", max:10,
          parts:[
            { text:"ã€ä¸­ã¯é‡‘å±ã€ãªã©æœ¬è³ªã«è§¦ã‚Œã¦ã„ã‚‹", max:3 },
            { text:"å¡—è£…/ã‚³ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã«æ°—ã¥ã‘ã¦ã„ã‚‹", max:4 },
            { text:"è‡ªåˆ†ã®è¨€è‘‰ã§ç­‹é“ç«‹ã¦ã¦èª¬æ˜ã§ãã‚‹", max:3 },
          ]
        },
        criteria:[]
      }
    ],

    L8: [
      { id:"K_L8", domain:"K", title:"ã¾ã¨ã‚ãƒ†ã‚¹ãƒˆï¼ˆçŸ¥è­˜ï¼š100ç‚¹ï¼‰",
        scoring:{ type:"manual", max:100 },
        grading:{ type:"testABC", aPct:0.95, cPct:0.70 },
        criteria:["å¾—ç‚¹ã‚’å…¥åŠ›ï¼ˆçŸ¥è­˜ï¼‰"],
      },
      { id:"T_L8", domain:"T", title:"ã¾ã¨ã‚ãƒ†ã‚¹ãƒˆï¼ˆæ€è€ƒï¼š50ç‚¹ï¼‰",
        scoring:{ type:"manual", max:50 },
        grading:{ type:"testABC", aPct:0.95, cPct:0.70 },
        criteria:["å¾—ç‚¹ã‚’å…¥åŠ›ï¼ˆæ€è€ƒï¼‰"],
      },
    ]
  },

  attitudeAcross: [
    { id:"A_ALL1", domain:"A", title:"ãµã‚Šã‹ãˆã‚Šã®è“„ç©ï¼ˆ8æ™‚é–“é€šã—ï¼‰",
      scoring:{ type:"manual", max:10 },
      criteria:[
        "æŒ¯ã‚Šè¿”ã‚ŠãŒç©ã¿ä¸ŠãŒã£ã¦ã„ã‚‹ï¼ˆå›æ•°/è³ªï¼‰",
        "å­¦ã³ã®è¨€èªåŒ–ãŒé€²ã‚“ã§ã„ã‚‹"
      ],
      note:"â€»æ¯å›æ›¸ã‘ãªã„å‰æã€‚ç©ºæ¬„ã§ã‚‚OKã€è¨˜éŒ²ã¯æŸ”è»Ÿã«ã€‚"
    },
    { id:"A_ALL2", domain:"A", title:"æˆæ¥­ä¸­ã®æ§˜å­ï¼ˆ8æ™‚é–“é€šã—ï¼šå®‰å…¨é…æ…®/å­¦ç¿’ã¸å‘ã‹ã†/å¿˜ã‚Œç‰©ç­‰ï¼‰",
      scoring:{ type:"manual", max:10 },
      criteria:["å®‰å…¨ã«é…æ…®ã—ã¦ã„ã‚‹","å­¦ç¿’ã¸å‘ã‹ãŠã†ã¨ã—ã¦ã„ã‚‹","å¿˜ã‚Œç‰©/æå‡ºãªã©"],
    }
  ],
};

/** =========================
 *  2) IndexedDBï¼ˆç«¯æœ«å†…ä¿å­˜ï¼‰
 * ========================= */
const DB_NAME = "SciEvalDB_v6_L12_ALL_testABC_subsum";
const DB_VER = 1;
const STORE = "state";

let db = null;
function openDB(){
  return new Promise((resolve,reject)=>{
    const req = indexedDB.open(DB_NAME, DB_VER);
    req.onupgradeneeded = ()=>{
      const d = req.result;
      if(!d.objectStoreNames.contains(STORE)){
        d.createObjectStore(STORE);
      }
    };
    req.onsuccess=()=>{ db=req.result; resolve(db); };
    req.onerror=()=>reject(req.error);
  });
}
function idbGet(key){
  return new Promise((resolve,reject)=>{
    const tx=db.transaction(STORE,"readonly");
    const st=tx.objectStore(STORE);
    const req=st.get(key);
    req.onsuccess=()=>resolve(req.result);
    req.onerror=()=>reject(req.error);
  });
}
function idbSet(key,val){
  return new Promise((resolve,reject)=>{
    const tx=db.transaction(STORE,"readwrite");
    const st=tx.objectStore(STORE);
    const req=st.put(val,key);
    req.onsuccess=()=>resolve(true);
    req.onerror=()=>reject(req.error);
  });
}
function idbDel(key){
  return new Promise((resolve,reject)=>{
    const tx=db.transaction(STORE,"readwrite");
    const st=tx.objectStore(STORE);
    const req=st.delete(key);
    req.onsuccess=()=>resolve(true);
    req.onerror=()=>reject(req.error);
  });
}

/** =========================
 *  3) çŠ¶æ…‹
 * ========================= */
const STATE_KEY = "app_state";
const nowISO = ()=> new Date().toISOString();

let state = {
  meta:{ unitName: CONFIG.unitDefault, updatedAt: nowISO() },
  roster: [],
  currentStudentId: "",
  currentLessonKey: CONFIG.lessons[0].key,
  uiMode: "student",
  currentItemGroupId: "",
  records: {},
};

function makeId(prefix="id"){
  return prefix + "_" + Math.random().toString(36).slice(2,9) + "_" + Date.now().toString(36);
}
function ensurePath(studentId, lessonKey){
  if(!state.records[studentId]) state.records[studentId] = {};
  if(!state.records[studentId][lessonKey]) state.records[studentId][lessonKey] = {};
  return state.records[studentId][lessonKey];
}
function ensureGroup(studentId, lessonKey, groupId){
  const lesson = ensurePath(studentId, lessonKey);
  if(!lesson[groupId]){
    lesson[groupId] = { score:null, checks:[], parts:[], memo:"", photos:[], grade:"â€”" };
  }else{
    if(lesson[groupId].grade == null) lesson[groupId].grade = "â€”";
    if(lesson[groupId].photos == null) lesson[groupId].photos = [];
    if(lesson[groupId].parts == null) lesson[groupId].parts = [];
  }
  return lesson[groupId];
}

/** âœ… èª­ã¿å–ã‚Šå°‚ç”¨ï¼ˆCSV/é›†è¨ˆã§stateã‚’å¢—ã‚„ã•ãªã„ï¼‰ */
function getGroup(studentId, lessonKey, groupId){
  return state.records?.[studentId]?.[lessonKey]?.[groupId] || null;
}
function getOverallMemoRO(studentId, lessonKey){
  return state.records?.[studentId]?.[lessonKey]?.__overall?.memo || "";
}

let saveTimer = null;
function markDirty(){
  state.meta.updatedAt = nowISO();
  const dot = document.getElementById("dot");
  dot.style.background = "var(--danger)";
  document.getElementById("saveState").textContent="ä¿å­˜ä¸­â€¦";
  if(saveTimer) clearTimeout(saveTimer);
  saveTimer = setTimeout(async ()=>{
    await idbSet(STATE_KEY, state);
    dot.style.background = "var(--ok)";
    document.getElementById("saveState").textContent="ä¿å­˜OK";
  }, 220);
}
function showToast(msg){
  const t=document.getElementById("toast");
  t.textContent=msg;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"), 1800);
}
function escapeHtml(s){
  return (s??"").toString()
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#39;");
}

function gradeFromRatio(r){
  const b = CONFIG.gradeBands;
  if(r >= b.A) return "A";
  if(r >= b.Bp) return "B+";
  if(r >= b.B) return "B";
  if(r >= b.Bm) return "B-";
  return "C";
}
function gradeClass(g){
  if(g==="A") return "A";
  if(g==="B+") return "Bp";
  if(g==="B") return "B";
  if(g==="B-") return "Bm";
  if(g==="C") return "C";
  return "B";
}

function getLessonGroups(lessonKey){
  if(lessonKey === "ALL"){
    return [...CONFIG.attitudeAcross];
  }
  return CONFIG.rubricByLesson[lessonKey] ? [...CONFIG.rubricByLesson[lessonKey]] : [];
}

function pointsForGroup(rec, g){
  const max = g.scoring?.max ?? 0;
  if(max <= 0) return 0;

  if(g.scoring?.type === "checkCount"){
    const cnt = (rec.checks || []).filter(Boolean).length;
    return Math.max(0, Math.min(max, cnt));
  }

  if(g.scoring?.type === "subsum"){
    const parts = g.scoring.parts || [];
    const arr = rec.parts || [];
    let sum = 0;
    for(let i=0;i<parts.length;i++){
      const pmax = parts[i].max ?? 0;
      let v = Number(arr[i] ?? 0);
      if(!Number.isFinite(v)) v = 0;
      v = Math.max(0, Math.min(pmax, v));
      sum += v;
    }
    return Math.max(0, Math.min(max, sum));
  }

  let points = (rec.score==null || rec.score==="") ? 0 : Number(rec.score);
  if(!Number.isFinite(points)) points = 0;
  return Math.max(0, Math.min(max, points));
}

function gradeForGroup(points, max, g){
  if(max <= 0) return "â€”";
  const p = Math.max(0, Math.min(max, points));

  if(g?.grading?.type === "testABC"){
    const aMin = Math.floor(max * (g.grading.aPct ?? 0.95));
    const cMin = Math.floor(max * (g.grading.cPct ?? 0.70));
    if(p >= aMin) return "A";
    if(p < cMin) return "C";
    return "B";
  }

  const r = p / max;
  if(r >= 0.90) return "A";
  if(r >= 0.75) return "B+";
  if(r >= 0.55) return "B";
  if(r >= 0.35) return "B-";
  return "C";
}

function updateSavedGrade(studentId, lessonKey, groupId){
  const groups = getLessonGroups(lessonKey);
  const g = groups.find(x => x.id === groupId);
  if(!g) return;
  const rec = ensureGroup(studentId, lessonKey, groupId);
  const pts = pointsForGroup(rec, g);
  rec.grade = gradeForGroup(pts, g.scoring?.max ?? 0, g);
}

function calcTotals(studentId, lessonKey){
  const groups = getLessonGroups(lessonKey);
  let sumK=0, sumT=0, sumA=0, sumAll=0, maxAll=0;
  for(const g of groups){
    const rec = ensureGroup(studentId, lessonKey, g.id);
    const max = g.scoring?.max ?? 0;
    maxAll += max;

    const points = pointsForGroup(rec, g);
    sumAll += points;
    if(g.domain==="K") sumK += points;
    if(g.domain==="T") sumT += points;
    if(g.domain==="A") sumA += points;
  }
  const ratio = maxAll>0 ? sumAll/maxAll : 0;
  return {sumK,sumT,sumA,sumAll,maxAll,grade:gradeFromRatio(ratio)};
}

function renderLessonSelect(){
  const sel = document.getElementById("lessonKey");
  sel.innerHTML = CONFIG.lessons.map(l=>`<option value="${escapeHtml(l.key)}">${escapeHtml(l.name)}</option>`).join("");
  sel.value = state.currentLessonKey;
}
function studentNameById(id){
  const st = state.roster.find(s=>s.id===id);
  return st ? st.name : "â€”";
}
function lessonNameByKey(k){
  const l = CONFIG.lessons.find(x=>x.key===k);
  return l ? l.name : k;
}

/** =========================
 *  ãƒ†ãƒ¼ãƒï¼ˆãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ï¼‰
 * ========================= */
function applyTheme(theme){
  document.documentElement.setAttribute("data-theme", theme);
  localStorage.setItem("theme", theme);
  const btn = document.getElementById("btnTheme");
  if(btn) btn.textContent = (theme==="dark") ? "â˜€ï¸ ãƒ©ã‚¤ãƒˆ" : "ğŸŒ™ ãƒ€ãƒ¼ã‚¯";
}
function initTheme(){
  const saved = localStorage.getItem("theme");
  if(saved === "light" || saved === "dark"){
    applyTheme(saved);
    return;
  }
  const prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
  applyTheme(prefersDark ? "dark" : "light");
}

/** =========================
 *  âœ… ãƒ¡ãƒ¢é«˜ã•ä¿å­˜ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆå¢—æ®–é˜²æ­¢ï¼‰
 * ========================= */
function memoHeightKey(type, studentId, lessonKey, groupId){
  return `memoH:${type}:${studentId||"-"}:${lessonKey||"-"}:${groupId||"-"}`;
}
function loadMemoHeight(type, studentId, lessonKey, groupId, fallbackPx){
  const k = memoHeightKey(type, studentId, lessonKey, groupId);
  const v = localStorage.getItem(k);
  const n = v ? Number(v) : NaN;
  if(Number.isFinite(n) && n>=60 && n<=1200) return n;
  return fallbackPx;
}
function saveMemoHeight(type, studentId, lessonKey, groupId, px){
  const k = memoHeightKey(type, studentId, lessonKey, groupId);
  localStorage.setItem(k, String(px));
}

/** âœ… é«˜ã•å¾©å…ƒï¼‹ä¿å­˜ï¼ˆåŒä¸€textareaã¸ã®äºŒé‡ç™»éŒ²ã‚’é˜²ãï¼‰ */
function bindMemoHeightOnce(textarea, type, studentId, lessonKey, groupId, fallbackPx){
  const h = loadMemoHeight(type, studentId, lessonKey, groupId, fallbackPx);
  textarea.style.height = h + "px";

  const bindKey = `bound_${type}_${studentId||"-"}_${lessonKey||"-"}_${groupId||"-"}`;
  if(textarea.dataset[bindKey] === "1") return;
  textarea.dataset[bindKey] = "1";

  const save = ()=> saveMemoHeight(type, studentId, lessonKey, groupId, textarea.offsetHeight);
  textarea.addEventListener("pointerup", save, {passive:true});
  textarea.addEventListener("blur", save);
}

/** =========================
 *  CSVå‡ºåŠ›ï¼ˆstateã‚’å¢—ã‚„ã•ãªã„ï¼‰
 * ========================= */
function csvEscape(v){
  const s = (v==null) ? "" : String(v);
  if(/[",\n]/.test(s)) return `"${s.replaceAll('"','""')}"`;
  return s;
}
function exportCSV(){
  const unit = state.meta?.unitName || "";
  const lessonKey = state.currentLessonKey;
  const lessonName = lessonNameByKey(lessonKey);
  const groups = getLessonGroups(lessonKey);

  const header = [
    "å˜å…ƒ","æˆæ¥­å›","å…ç«¥å",
    ...groups.flatMap(g => [
      `${CONFIG.domains[g.domain].label}ï½œ${g.title}ï½œç‚¹æ•°`,
      `${CONFIG.domains[g.domain].label}ï½œ${g.title}ï½œæº€ç‚¹`,
      `${CONFIG.domains[g.domain].label}ï½œ${g.title}ï½œè©•ä¾¡`,
      `${CONFIG.domains[g.domain].label}ï½œ${g.title}ï½œãƒ¡ãƒ¢`,
      `${CONFIG.domains[g.domain].label}ï½œ${g.title}ï½œå†™çœŸæšæ•°`,
    ]),
    "å…¨ä½“ãƒ¡ãƒ¢"
  ];

  const rows = [header];

  for(const st of (state.roster||[])){
    const row = [unit, lessonName, st.name];

    for(const g of groups){
      const rec = getGroup(st.id, lessonKey, g.id) || { score:null, checks:[], parts:[], memo:"", photos:[], grade:"â€”" };
      const pts = pointsForGroup(rec, g);
      const max = g.scoring?.max ?? 0;
      const gr = (rec.grade && rec.grade !== "â€”") ? rec.grade : gradeForGroup(pts, max, g);
      const photoCount = (rec.photos||[]).length;

      row.push(pts, max, gr, rec.memo||"", photoCount);
    }

    row.push(getOverallMemoRO(st.id, lessonKey));
    rows.push(row);
  }

  const csv = rows.map(r => r.map(csvEscape).join(",")).join("\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `sci_eval_${unit || "unit"}_${lessonKey}_${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
  URL.revokeObjectURL(a.href);
  showToast("CSVã‚’å‡ºåŠ›ã—ãŸ");
}

/** =========================
 *  åç°¿è¡¨ç¤º
 * ========================= */
function renderRosterList(){
  const list = document.getElementById("studentList");
  list.innerHTML = "";
  if(state.roster.length===0){
    const div=document.createElement("div");
    div.className="muted";
    div.textContent="åç°¿ã‚’å…¥åŠ›ã—ã¦ã€Œåç°¿ã‚’åæ˜ ã€ã—ã¦ãã ã•ã„ã€‚";
    list.appendChild(div);
    return;
  }
  for(const st of state.roster){
    const btn=document.createElement("div");
    btn.className="student" + (st.id===state.currentStudentId ? " active":"");
    const totals = calcTotals(st.id, state.currentLessonKey);
    btn.innerHTML = `
      <div style="display:flex; flex-direction:column; gap:2px;">
        <b>${escapeHtml(st.name)}</b>
        <span class="mini">æ›´æ–°ï¼š${new Date(state.meta.updatedAt).toLocaleString()}</span>
      </div>
      <div style="display:flex; flex-direction:column; align-items:flex-end; gap:6px;">
        <span class="grade ${gradeClass(totals.grade)}">${escapeHtml(totals.grade)}</span>
        <span class="mini">${totals.sumAll}/${totals.maxAll}</span>
      </div>
    `;
    btn.addEventListener("click", ()=>{
      state.currentStudentId = st.id;
      markDirty();
      renderAll();
    });
    list.appendChild(btn);
  }
}

/** =========================
 *  å†™çœŸï¼ˆç„¡åˆ¶é™ï¼‰ï¼‹æ³¨é‡ˆ
 * ========================= */
function makePhotoBlock(studentId, lessonKey, groupId){
  const rec = ensureGroup(studentId, lessonKey, groupId);
  const photos = rec.photos || [];
  const wrap = document.createElement("div");
  wrap.className="photoArea";

  const top = document.createElement("div");
  top.style.display="flex";
  top.style.gap="8px";
  top.style.flexWrap="wrap";
  top.style.justifyContent="space-between";
  top.innerHTML = `
    <div class="mini">å†™çœŸï¼ˆç„¡åˆ¶é™ï¼‰ï½œã‚¿ãƒƒãƒ—ï¼æ³¨é‡ˆï¼ˆãƒšãƒ³/å›³å½¢ï¼‰</div>
    <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; align-items:center;">
      <input type="file" accept="image/*" multiple style="display:none"
             data-photoadd="1"
             data-student="${escapeHtml(studentId)}"
             data-lesson="${escapeHtml(lessonKey)}"
             data-group="${escapeHtml(groupId)}">
      <button class="btn small" type="button"
              data-open-picker="1"
              data-student="${escapeHtml(studentId)}"
              data-lesson="${escapeHtml(lessonKey)}"
              data-group="${escapeHtml(groupId)}">ï¼‹ å†™çœŸã‚’è¿½åŠ </button>
    </div>
  `;

  const strip = document.createElement("div");
  strip.className="photoStrip";

  for(const p of photos){
    const th = document.createElement("div");
    th.className="thumb";
    th.innerHTML = `
      <img src="${p.thumbDataUrl || p.baseDataUrl}" alt="thumb">
      <button class="x" type="button" title="å‰Šé™¤">Ã—</button>
      <div class="lbl">æ³¨é‡ˆ</div>
    `;
    th.querySelector(".x").addEventListener("click", (e)=>{
      e.stopPropagation();
      rec.photos = (rec.photos||[]).filter(x=>x.id!==p.id);
      markDirty();
      renderAll();
    });
    th.addEventListener("click", ()=>{
      openAnnotator(studentId, lessonKey, groupId, p.id);
    });
    strip.appendChild(th);
  }

  wrap.appendChild(top);
  wrap.appendChild(strip);
  return wrap;
}

function makeMiniPhotoUI(studentId, lessonKey, groupId){
  const rec = ensureGroup(studentId, lessonKey, groupId);
  const photos = rec.photos || [];
  const box = document.createElement("div");
  box.style.display="flex";
  box.style.flexDirection="column";
  box.style.gap="8px";
  box.style.alignItems="flex-end";

  const top = document.createElement("div");
  top.style.display="flex";
  top.style.gap="8px";
  top.style.alignItems="center";
  top.style.flexWrap="wrap";
  top.style.justifyContent="flex-end";
  top.innerHTML = `
    <span class="tag gray">å†™çœŸï¼š${photos.length}</span>
    <input type="file" accept="image/*" multiple style="display:none"
      data-photoadd="1"
      data-student="${escapeHtml(studentId)}"
      data-lesson="${escapeHtml(lessonKey)}"
      data-group="${escapeHtml(groupId)}">
    <button class="btn small" type="button"
      data-open-picker="1"
      data-student="${escapeHtml(studentId)}"
      data-lesson="${escapeHtml(lessonKey)}"
      data-group="${escapeHtml(groupId)}">ï¼‹å†™çœŸ</button>
  `;

  const strip = document.createElement("div");
  strip.style.display="flex";
  strip.style.gap="8px";
  strip.style.flexWrap="wrap";
  strip.style.justifyContent="flex-end";

  const show = photos.slice(-6);
  for(const p of show){
    const th = document.createElement("div");
    th.className="thumbMini";
    th.innerHTML = `
      <img src="${p.thumbDataUrl || p.baseDataUrl}" alt="thumb">
      <button class="x" type="button" title="å‰Šé™¤">Ã—</button>
    `;
    th.querySelector(".x").addEventListener("click", (e)=>{
      e.stopPropagation();
      rec.photos = (rec.photos||[]).filter(x=>x.id!==p.id);
      markDirty();
      renderAll();
    });
    th.addEventListener("click", ()=>{
      openAnnotator(studentId, lessonKey, groupId, p.id);
    });
    strip.appendChild(th);
  }

  box.appendChild(top);
  box.appendChild(strip);
  return box;
}

/** âœ… å†™çœŸã‚’åœ§ç¸®ã—ã¦ä¿å­˜ï¼ˆå®¹é‡å¯¾ç­–ï¼‰ */
async function fileToCompressedDataUrl(file, maxW=1600, quality=0.8){
  const bmp = await createImageBitmap(file);
  const scale = Math.min(1, maxW / bmp.width);
  const w = Math.round(bmp.width * scale);
  const h = Math.round(bmp.height * scale);

  const c = document.createElement("canvas");
  c.width = w; c.height = h;
  const ctx = c.getContext("2d");
  ctx.drawImage(bmp, 0, 0, w, h);
  return c.toDataURL("image/jpeg", quality);
}

/** =========================
 *  å…ç«¥ãƒ¢ãƒ¼ãƒ‰ï¼ˆ1äººãšã¤ï¼‰
 * ========================= */
function renderRubric(){
  const wrap = document.getElementById("rubric");
  wrap.innerHTML = "";
  const sid = state.currentStudentId;
  if(!sid){
    wrap.innerHTML = `<div class="muted">åç°¿ã‹ã‚‰å…ç«¥ã‚’é¸ã¶ã¨æ¡ç‚¹ã§ãã¾ã™ã€‚</div>`;
    return;
  }

  const lessonKey = state.currentLessonKey;
  const groups = getLessonGroups(lessonKey);

  for(const g of groups){
    const rec = ensureGroup(sid, lessonKey, g.id);
    updateSavedGrade(sid, lessonKey, g.id);

    const det = document.createElement("details");
    det.open = true;

    const pts = pointsForGroup(rec, g);
    det.innerHTML = `
      <summary>
        <div class="sumL">
          <span class="tag ${g.domain==="K"?"k":g.domain==="T"?"t":"a"}">${escapeHtml(CONFIG.domains[g.domain].label)}</span>
          <b style="font-size:14px;">${escapeHtml(g.title)}</b>
          ${g.note ? `<span class="tag gray">${escapeHtml(g.note)}</span>` : ""}
        </div>
        <div class="sumR">
          <span class="tag gray">${pts}/${g.scoring?.max ?? 0}ç‚¹</span>
          <span class="tag gray">è©•ä¾¡ï¼š${escapeHtml(rec.grade || "â€”")}</span>
        </div>
      </summary>
    `;

    const block = document.createElement("div");
    block.className="block";

    const scoreRow = document.createElement("div");
    scoreRow.className="scoreRow";

    const left = document.createElement("div");
    left.style.flex="1";
    left.style.minWidth="260px";

    let critHtml = "";
    if(g.scoring?.type === "subsum"){
      const parts = g.scoring.parts || [];
      critHtml = parts.map((p, idx)=>`
        <div style="display:flex; gap:10px; align-items:flex-start; margin:8px 0;">
          <span class="tag gray" style="min-width:34px; text-align:center;">${idx+1}</span>
          <span>${escapeHtml(p.text)} <span class="mini">ï¼ˆ${p.max}ç‚¹ï¼‰</span></span>
        </div>
      `).join("");
    }else{
      const crit = (g.criteria||[]);
      critHtml = crit.map((c, idx)=>{
        if(g.scoring?.type==="checkCount"){
          const checked = !!(rec.checks||[])[idx];
          return `
            <label style="display:flex; gap:10px; align-items:flex-start; margin:10px 0; cursor:pointer;">
              <input type="checkbox" data-check="1" data-group="${escapeHtml(g.id)}" data-idx="${idx}" ${checked?"checked":""}
                     style="width:22px; height:22px; margin-top:2px;">
              <span>${escapeHtml(c)}</span>
            </label>
          `;
        }
        return `
          <div style="display:flex; gap:10px; align-items:flex-start; margin:8px 0;">
            <span class="tag gray" style="min-width:34px; text-align:center;">${idx+1}</span>
            <span>${escapeHtml(c)}</span>
          </div>
        `;
      }).join("");
    }

    left.innerHTML = `<div class="mini">åŸºæº–ï¼ˆæˆæ¥­ä¸­ã«è¦‹ãªãŒã‚‰åˆ¤æ–­ï¼‰</div><div>${critHtml || `<span class="mini">ï¼ˆåŸºæº–ãªã—ï¼‰</span>`}</div>`;

    const right = document.createElement("div");
    right.style.minWidth="280px";
    right.style.display="flex";
    right.style.flexDirection="column";
    right.style.gap="10px";
    right.style.alignItems="stretch";

    let scoreUI = "";

    if(g.scoring?.type==="checkCount"){
      const cnt = (rec.checks||[]).filter(Boolean).length;
      scoreUI = `
        <div class="field">
          <label>é”æˆæ•°ï¼ˆè‡ªå‹•ï¼‰</label>
          <input class="input num" value="${cnt}" readonly />
          <div class="hint">ãƒã‚§ãƒƒã‚¯æ•°ï¼å¾—ç‚¹ï¼ˆæœ€å¤§ ${g.scoring.max}ï¼‰</div>
        </div>
      `;
    } else if(g.scoring?.type==="subsum"){
      const parts = g.scoring.parts || [];
      const arr = rec.parts || [];
      const rows = parts.map((p, idx)=>{
        const v = (arr[idx]==null) ? 0 : arr[idx];
        return `
          <div style="display:flex; gap:10px; align-items:center; justify-content:space-between; margin:8px 0;">
            <div style="flex:1; min-width:180px;">
              <span class="tag gray" style="margin-right:6px;">${idx+1}</span>
              <span>${escapeHtml(p.text)}</span>
            </div>
            <div style="display:flex; gap:8px; align-items:center;">
              <input class="input" style="width:86px; text-align:center; font-weight:800;"
                     inputmode="numeric" pattern="[0-9]*"
                     data-partscore="1" data-group="${escapeHtml(g.id)}" data-idx="${idx}"
                     value="${escapeHtml(v)}" />
              <span class="mini">/ ${p.max}</span>
            </div>
          </div>
        `;
      }).join("");

      scoreUI = `
        <div class="field">
          <label>ç‚¹æ•°ï¼ˆå„ãƒã‚§ãƒƒã‚¯ã®åˆè¨ˆï¼šè‡ªå‹•ï¼‰</label>
          <div class="hint">å„é …ç›®ã«ç‚¹æ•° â†’ åˆè¨ˆãŒ ${g.scoring.max} ç‚¹æº€ç‚¹</div>
        </div>
        <div>${rows}</div>
        <div class="tag gray" style="display:inline-flex; margin-top:6px;">
          åˆè¨ˆï¼š${pointsForGroup(rec, g)}/${g.scoring.max}ç‚¹
        </div>
      `;
    } else {
      const v = (rec.score==null) ? "" : rec.score;
      scoreUI = `
        <div class="field">
          <label>ç‚¹æ•°ï¼ˆ0ã€œ${g.scoring.max}ï¼‰</label>
          <input class="input num" inputmode="numeric" pattern="[0-9]*" data-score="1" data-group="${escapeHtml(g.id)}"
                 value="${escapeHtml(v)}" placeholder="0" />
          <div class="hint">â€»ã‚ãªãŸãŒå…¥åŠ›</div>
        </div>
      `;
    }

    right.innerHTML = `
      ${scoreUI}
      <div class="field">
        <label>ãƒ¡ãƒ¢ï¼ˆã“ã®é …ç›®ï¼‰â€»é«˜ã•ã¯è‡ªç”±ã«å¤‰ãˆã‚‰ã‚Œã¾ã™</label>
        <textarea data-memo="1" data-group="${escapeHtml(g.id)}" placeholder="è¦‹å–ã‚Šï¼å£°ã‹ã‘ï¼æ¬¡ã®æ‰‹ç«‹ã¦">${escapeHtml(rec.memo||"")}</textarea>
      </div>
    `;

    scoreRow.appendChild(left);
    scoreRow.appendChild(right);

    const itemCard = document.createElement("div");
    itemCard.className="itemCard";
    itemCard.appendChild(scoreRow);
    itemCard.appendChild(makePhotoBlock(sid, lessonKey, g.id));

    block.appendChild(itemCard);
    det.appendChild(block);
    wrap.appendChild(det);

    setTimeout(()=>{
      const ta = right.querySelector(`textarea[data-memo="1"][data-group="${CSS.escape(g.id)}"]`);
      if(ta){
        bindMemoHeightOnce(ta, "group", sid, lessonKey, g.id, 110);
      }
    }, 0);
  }
}

/** =========================
 *  é …ç›®ãƒ¢ãƒ¼ãƒ‰ï¼ˆé …ç›®1ã¤â†’å…¨å“¡åˆ†å…¥åŠ›ï¼‰
 * ========================= */
function promptPartsAndSave(studentId, lessonKey, group){
  const rec = ensureGroup(studentId, lessonKey, group.id);
  const parts = group.scoring.parts || [];
  rec.parts = rec.parts || [];

  for(let i=0;i<parts.length;i++){
    const p = parts[i];
    const cur = Number(rec.parts[i] ?? 0);
    const ans = prompt(`ã€${studentNameById(studentId)}ã€‘\n${group.title}\n${i+1}. ${p.text}\n(0ã€œ${p.max})`, String(cur));
    if(ans === null) return;
    let v = String(ans).replace(/[^\d]/g,"");
    let n = v==="" ? 0 : Number(v);
    if(!Number.isFinite(n)) n = 0;
    n = Math.max(0, Math.min(p.max, n));
    rec.parts[i] = n;
  }

  updateSavedGrade(studentId, lessonKey, group.id);
  markDirty();
  renderRosterList();
  updateTotalsUI();
  renderItemMode();
  showToast("é…ç‚¹ã‚’ä¿å­˜ã—ãŸ");
}

function renderItemMode(){
  const panel = document.getElementById("itemModePanel");
  const sel = document.getElementById("itemGroupSelect");
  const list = document.getElementById("itemList");
  panel.style.display = "block";
  list.innerHTML = "";

  if(state.roster.length===0){
    list.innerHTML = `<div class="muted">åç°¿ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</div>`;
    return;
  }

  const lessonKey = state.currentLessonKey;
  const groups = getLessonGroups(lessonKey);

  sel.innerHTML = groups.map(g=>{
    return `<option value="${escapeHtml(g.id)}">${escapeHtml(CONFIG.domains[g.domain].label)}ï½œ${escapeHtml(g.title)}</option>`;
  }).join("");

  if(!state.currentItemGroupId || !groups.find(g=>g.id===state.currentItemGroupId)){
    state.currentItemGroupId = groups[0]?.id || "";
  }
  sel.value = state.currentItemGroupId;

  const group = groups.find(g=>g.id===state.currentItemGroupId);
  if(!group){
    list.innerHTML = `<div class="muted">é …ç›®ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>`;
    return;
  }

  for(const st of state.roster){
    const rec = ensureGroup(st.id, lessonKey, group.id);
    updateSavedGrade(st.id, lessonKey, group.id);

    const row = document.createElement("div");
    row.className = "itemRow";

    const left = document.createElement("div");
    left.style.minWidth="220px";
    left.style.flex="1";
    const pts = pointsForGroup(rec, group);

    left.innerHTML = `
      <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
        <b>${escapeHtml(st.name)}</b>
        <span class="tag ${group.domain==="K"?"k":group.domain==="T"?"t":"a"}">${escapeHtml(CONFIG.domains[group.domain].label)}</span>
        <span class="tag gray">${group.scoring.max}ç‚¹</span>
        <span class="tag gray">åˆè¨ˆï¼š${pts}/${group.scoring.max}</span>
      </div>
      <div class="mini">${escapeHtml(group.title)}</div>
    `;

    const right = document.createElement("div");
    right.className = "itemSide";

    const topLine = document.createElement("div");
    topLine.style.display="flex";
    topLine.style.gap="8px";
    topLine.style.alignItems="center";
    topLine.style.flexWrap="wrap";
    topLine.style.justifyContent="flex-end";

    if(group.scoring.type === "checkCount"){
      const checks = rec.checks || [];
      const max = group.scoring.max;

      const checksWrap = document.createElement("div");
      checksWrap.className = "smallChecks";
      for(let i=0;i<max;i++){
        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.checked = !!checks[i];
        cb.addEventListener("change", ()=>{
          rec.checks = rec.checks || [];
          rec.checks[i] = cb.checked;
          updateSavedGrade(st.id, lessonKey, group.id);
          markDirty();
          renderRosterList();
          updateTotalsUI();
          renderItemMode();
        });
        checksWrap.appendChild(cb);
      }
      topLine.appendChild(checksWrap);

      const cnt = checks.filter(Boolean).length;
      const cntTag = document.createElement("span");
      cntTag.className="tag gray";
      cntTag.textContent = `é”æˆï¼š${cnt}/${max}`;
      topLine.appendChild(cntTag);

    } else if(group.scoring.type === "subsum"){
      const btn = document.createElement("button");
      btn.className = "btn small primary";
      btn.type = "button";
      btn.textContent = "é…ç‚¹å…¥åŠ›";
      btn.addEventListener("click", ()=>{
        promptPartsAndSave(st.id, lessonKey, group);
      });
      topLine.appendChild(btn);

    } else {
      const inp = document.createElement("input");
      inp.className = "input num";
      inp.inputMode = "numeric";
      inp.placeholder = "0";
      inp.value = (rec.score==null) ? "" : rec.score;
      inp.addEventListener("input", ()=>{
        let v = inp.value.replace(/[^\d]/g,"");
        if(v===""){ rec.score=null; updateSavedGrade(st.id, lessonKey, group.id); markDirty(); renderRosterList(); updateTotalsUI(); renderItemMode(); return; }
        let n = Number(v);
        if(!Number.isFinite(n)) n=0;
        n = Math.max(0, Math.min(group.scoring.max, n));
        rec.score = n;
        if(String(n)!==inp.value) inp.value = n;
        updateSavedGrade(st.id, lessonKey, group.id);
        markDirty();
        renderRosterList();
        updateTotalsUI();
        renderItemMode();
      });
      topLine.appendChild(inp);
    }

    const gtag = document.createElement("span");
    gtag.className = "tag gray";
    gtag.textContent = `è©•ä¾¡ï¼š${rec.grade || "â€”"}`;
    topLine.appendChild(gtag);

    const detailBtn = document.createElement("button");
    detailBtn.className="btn small";
    detailBtn.type="button";
    detailBtn.textContent="è©³ç´°";
    detailBtn.addEventListener("click", ()=>{
      state.uiMode = "student";
      state.currentStudentId = st.id;
      markDirty();
      renderAll();
      showToast("å…ç«¥ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡æ›¿");
    });
    topLine.appendChild(detailBtn);

    const memo = document.createElement("textarea");
    memo.className = "miniMemo";
    memo.placeholder = "ãƒ¡ãƒ¢ï¼ˆã“ã®é …ç›®ï¼‰â€»é«˜ã•ã¯è‡ªç”±ã«å¤‰ãˆã‚‰ã‚Œã¾ã™";
    memo.value = rec.memo || "";
    memo.addEventListener("input", ()=>{
      rec.memo = memo.value || "";
      markDirty();
    });

    bindMemoHeightOnce(memo, "itemmode", st.id, lessonKey, group.id, 90);

    const photoUI = makeMiniPhotoUI(st.id, lessonKey, group.id);

    right.appendChild(topLine);
    right.appendChild(memo);
    right.appendChild(photoUI);

    row.appendChild(left);
    row.appendChild(right);
    list.appendChild(row);
  }
}

/** =========================
 *  æ³¨é‡ˆï¼ˆãƒšãƒ³ï¼å›³å½¢ï¼æ–‡å­—ï¼æ¶ˆã—ã‚´ãƒ ï¼‰
 * ========================= */
const modal = document.getElementById("modal");
const baseImg = document.getElementById("baseImg");
const ink = document.getElementById("ink");

const penColor = document.getElementById("penColor");
const penSize = document.getElementById("penSize");
const penSizeVal = document.getElementById("penSizeVal");

let tool = "pen";
let draw = { active:false, startX:0, startY:0, lastX:0, lastY:0 };
let hist = [];
let current = { studentId:"", lessonKey:"", groupId:"", photoId:"" };

function setTool(t){
  tool=t;
  const ids = ["toolPen","toolEraser","toolObjEraser","toolLine","toolArrow","toolRect","toolCircle","toolEllipse","toolTri","toolText"];
  for(const id of ids){
    const el = document.getElementById(id);
    if(!el) continue;
    el.classList.remove("primary","warn","danger");
  }
  if(t==="pen") document.getElementById("toolPen").classList.add("primary");
  if(t==="eraser") document.getElementById("toolEraser").classList.add("warn");
  if(t==="obj") document.getElementById("toolObjEraser").classList.add("danger");
  if(["line","arrow","rect","circle","ellipse","tri","text"].includes(t)){
    const map = {line:"toolLine",arrow:"toolArrow",rect:"toolRect",circle:"toolCircle",ellipse:"toolEllipse",tri:"toolTri",text:"toolText"};
    document.getElementById(map[t]).classList.add("primary");
  }
}
function fitCanvasToImage(){
  const w = baseImg.naturalWidth;
  const h = baseImg.naturalHeight;
  ink.width = w;
  ink.height = h;
  ink.style.width = baseImg.clientWidth + "px";
  ink.style.height = baseImg.clientHeight + "px";
}
function syncCanvasCss(){
  ink.style.width = baseImg.clientWidth + "px";
  ink.style.height = baseImg.clientHeight + "px";
}
window.addEventListener("resize", ()=> {
  if(modal.classList.contains("show")) syncCanvasCss();
});
function getPhotoRef(studentId, lessonKey, groupId, photoId){
  const rec = ensureGroup(studentId, lessonKey, groupId);
  return (rec.photos||[]).find(p=>p.id===photoId);
}
function pushUndo(){
  hist.push(ink.toDataURL("image/png"));
  if(hist.length>30) hist.shift();
}
function loadInkFromDataUrl(dataUrl){
  const ctx = ink.getContext("2d");
  ctx.clearRect(0,0,ink.width, ink.height);
  if(!dataUrl) return;
  const img = new Image();
  img.onload = ()=> ctx.drawImage(img,0,0,ink.width, ink.height);
  img.src = dataUrl;
}
function drawLine(ctx, x1,y1,x2,y2, color, size, mode="source-over"){
  ctx.save();
  ctx.globalCompositeOperation = mode;
  ctx.strokeStyle = color;
  ctx.lineWidth = size;
  ctx.lineCap = "round";
  ctx.lineJoin = "round";
  ctx.beginPath();
  ctx.moveTo(x1,y1);
  ctx.lineTo(x2,y2);
  ctx.stroke();
  ctx.restore();
}
function drawRect(ctx, x1,y1,x2,y2, color, size){
  ctx.save();
  ctx.strokeStyle=color;
  ctx.lineWidth=size;
  ctx.beginPath();
  ctx.rect(x1,y1,(x2-x1),(y2-y1));
  ctx.stroke();
  ctx.restore();
}
function drawLineSeg(ctx, x1,y1,x2,y2, color, size){ drawLine(ctx, x1,y1,x2,y2, color, size, "source-over"); }
function drawArrow(ctx, x1,y1,x2,y2, color, size){
  drawLineSeg(ctx, x1,y1,x2,y2, color, size);
  const ang = Math.atan2(y2-y1, x2-x1);
  const head = Math.max(10, size*4);
  const a1 = ang + Math.PI*0.85;
  const a2 = ang - Math.PI*0.85;
  ctx.save();
  ctx.strokeStyle=color;
  ctx.lineWidth=size;
  ctx.lineCap="round";
  ctx.beginPath();
  ctx.moveTo(x2,y2);
  ctx.lineTo(x2 + head*Math.cos(a1), y2 + head*Math.sin(a1));
  ctx.moveTo(x2,y2);
  ctx.lineTo(x2 + head*Math.cos(a2), y2 + head*Math.sin(a2));
  ctx.stroke();
  ctx.restore();
}
function drawEllipse(ctx, x1,y1,x2,y2, color, size){
  const cx = (x1+x2)/2, cy=(y1+y2)/2;
  const rx = Math.abs(x2-x1)/2, ry=Math.abs(y2-y1)/2;
  ctx.save();
  ctx.strokeStyle=color;
  ctx.lineWidth=size;
  ctx.beginPath();
  ctx.ellipse(cx, cy, Math.max(1,rx), Math.max(1,ry), 0, 0, Math.PI*2);
  ctx.stroke();
  ctx.restore();
}
function drawTriangle(ctx, x1,y1,x2,y2, color, size){
  const topY = Math.min(y1,y2);
  const botY = Math.max(y1,y2);
  const leftX = Math.min(x1,x2);
  const rightX = Math.max(x1,x2);
  const cx = (leftX+rightX)/2;
  ctx.save();
  ctx.strokeStyle=color;
  ctx.lineWidth=size;
  ctx.beginPath();
  ctx.moveTo(cx, topY);
  ctx.lineTo(rightX, botY);
  ctx.lineTo(leftX, botY);
  ctx.closePath();
  ctx.stroke();
  ctx.restore();
}
function putTextAt(ctx, x,y, text, color, size){
  ctx.save();
  ctx.fillStyle=color;
  ctx.font = `${Math.max(12, size*3)}px ui-sans-serif, system-ui, -apple-system, "Hiragino Sans", "Noto Sans JP"`;
  ctx.fillText(text, x, y);
  ctx.restore();
}

async function openAnnotator(studentId, lessonKey, groupId, photoId){
  const p = getPhotoRef(studentId, lessonKey, groupId, photoId);
  if(!p) return;

  current = {studentId, lessonKey, groupId, photoId};
  document.getElementById("modalTitle").textContent = "å†™çœŸæ³¨é‡ˆ";
  document.getElementById("modalSub").textContent = `${studentNameById(studentId)}ï½œ${lessonNameByKey(lessonKey)}`;

  hist = [];
  setTool("pen");
  penSizeVal.textContent = penSize.value;

  baseImg.onload = ()=>{
    setTimeout(()=>{
      fitCanvasToImage();
      loadInkFromDataUrl(p.inkLayer || null);
      syncCanvasCss();
    }, 0);
  };
  baseImg.src = p.baseDataUrl;

  modal.classList.add("show");
}
function closeAnnotator(){
  modal.classList.remove("show");
  current = { studentId:"", lessonKey:"", groupId:"", photoId:"" };
}

function canvasPoint(e){
  const rect = ink.getBoundingClientRect();
  const sx = ink.width / rect.width;
  const sy = ink.height / rect.height;
  const x = (e.clientX - rect.left) * sx;
  const y = (e.clientY - rect.top) * sy;
  return {x, y};
}

ink.addEventListener("pointerdown", (e)=>{
  e.preventDefault();
  if(!modal.classList.contains("show")) return;
  ink.setPointerCapture(e.pointerId);

  const ctx = ink.getContext("2d");
  const {x,y} = canvasPoint(e);

  if(tool==="obj"){
    pushUndo();
    ctx.save();
    ctx.globalCompositeOperation="destination-out";
    ctx.beginPath();
    ctx.arc(x,y, 22, 0, Math.PI*2);
    ctx.fill();
    ctx.restore();
    markDirty();
    return;
  }

  draw.active=true;
  draw.startX=x; draw.startY=y;
  draw.lastX=x; draw.lastY=y;

  if(tool==="pen" || tool==="eraser"){
    pushUndo();
    drawLine(ctx, x,y,x,y, penColor.value, Number(penSize.value),
      tool==="eraser" ? "destination-out" : "source-over"
    );
  }else if(["rect","line","arrow","circle","ellipse","tri"].includes(tool)){
    pushUndo();
  }
});
ink.addEventListener("pointermove", (e)=>{
  if(!draw.active) return;
  e.preventDefault();
  const ctx = ink.getContext("2d");
  const {x,y} = canvasPoint(e);

  if(tool==="pen" || tool==="eraser"){
    drawLine(ctx, draw.lastX, draw.lastY, x, y, penColor.value, Number(penSize.value),
      tool==="eraser" ? "destination-out" : "source-over"
    );
    draw.lastX=x; draw.lastY=y;
  }else if(["rect","line","arrow","circle","ellipse","tri"].includes(tool)){
    const last = hist[hist.length-1];
    if(last){
      loadInkFromDataUrl(last);
      setTimeout(()=>{
        const ctx2 = ink.getContext("2d");
        const c = penColor.value;
        const s = Number(penSize.value);

        if(tool==="rect") drawRect(ctx2, draw.startX, draw.startY, x, y, c, s);
        if(tool==="line") drawLineSeg(ctx2, draw.startX, draw.startY, x, y, c, s);
        if(tool==="arrow") drawArrow(ctx2, draw.startX, draw.startY, x, y, c, s);

        if(tool==="circle"){
          const dx = x - draw.startX, dy = y - draw.startY;
          const r = Math.max(Math.abs(dx), Math.abs(dy));
          drawEllipse(ctx2, draw.startX, draw.startY,
            draw.startX + Math.sign(dx||1)*r,
            draw.startY + Math.sign(dy||1)*r, c, s);
        }
        if(tool==="ellipse") drawEllipse(ctx2, draw.startX, draw.startY, x, y, c, s);
        if(tool==="tri") drawTriangle(ctx2, draw.startX, draw.startY, x, y, c, s);
      }, 0);
    }
  }
});
ink.addEventListener("pointerup", (e)=>{ if(!draw.active) return; e.preventDefault(); draw.active=false; });

ink.addEventListener("click", (e)=>{
  if(!modal.classList.contains("show")) return;
  if(tool!=="text") return;
  const ctx = ink.getContext("2d");
  const {x,y} = canvasPoint(e);
  const text = prompt("æŒ¿å…¥ã™ã‚‹æ–‡å­—ï¼ˆçŸ­ã‚ï¼‰");
  if(text==null) return;
  pushUndo();
  putTextAt(ctx, x, y, text, penColor.value, Number(penSize.value));
  markDirty();
});

/** âœ… æ³¨é‡ˆã‚µãƒ ãƒï¼šinkåŸºæº–ã§å®‰å®šåŒ– */
function makeThumbFromBaseAndInk(baseDataUrl){
  try{
    const w = ink.width || baseImg.naturalWidth;
    const h = ink.height || baseImg.naturalHeight;
    if(!w || !h) return baseDataUrl;

    const c = document.createElement("canvas");
    c.width = w;
    c.height = h;
    const ctx = c.getContext("2d");

    if(baseImg.naturalWidth){
      ctx.drawImage(baseImg, 0, 0, w, h);
    }else{
      return baseDataUrl;
    }

    ctx.drawImage(ink, 0, 0, w, h);
    return c.toDataURL("image/jpeg", 0.85);
  }catch{
    return baseDataUrl;
  }
}

document.getElementById("btnUndo").addEventListener("click", ()=>{
  if(hist.length===0){ showToast("æˆ»ã›ã‚‹å±¥æ­´ãŒãªã„"); return; }
  const last = hist.pop();
  loadInkFromDataUrl(last);
  markDirty();
});
document.getElementById("btnClearInk").addEventListener("click", ()=>{
  const ctx = ink.getContext("2d");
  pushUndo();
  ctx.clearRect(0,0,ink.width, ink.height);
  markDirty();
});
document.getElementById("btnSaveInk").addEventListener("click", ()=>{
  const p = getPhotoRef(current.studentId, current.lessonKey, current.groupId, current.photoId);
  if(!p) return;
  p.inkLayer = ink.toDataURL("image/png");
  p.thumbDataUrl = makeThumbFromBaseAndInk(p.baseDataUrl);
  markDirty();
  showToast("æ³¨é‡ˆã‚’ä¿å­˜ã—ãŸ");
  renderAll();
});
document.getElementById("btnClose").addEventListener("click", closeAnnotator);

penSize.addEventListener("input", ()=> penSizeVal.textContent = penSize.value);

document.getElementById("toolPen").addEventListener("click", ()=> setTool("pen"));
document.getElementById("toolEraser").addEventListener("click", ()=> setTool("eraser"));
document.getElementById("toolObjEraser").addEventListener("click", ()=> setTool("obj"));
document.getElementById("toolLine").addEventListener("click", ()=> setTool("line"));
document.getElementById("toolArrow").addEventListener("click", ()=> setTool("arrow"));
document.getElementById("toolRect").addEventListener("click", ()=> setTool("rect"));
document.getElementById("toolCircle").addEventListener("click", ()=> setTool("circle"));
document.getElementById("toolEllipse").addEventListener("click", ()=> setTool("ellipse"));
document.getElementById("toolTri").addEventListener("click", ()=> setTool("tri"));
document.getElementById("toolText").addEventListener("click", ()=> setTool("text"));

/** =========================
 *  å†™çœŸè¿½åŠ ï¼ˆiPad Safariã§ç¢ºå®Ÿã«é–‹ãï¼‰
 * ========================= */
document.addEventListener("click", (e)=>{
  const t = e.target;
  const openBtn = t.closest("button[data-open-picker='1']");
  if(openBtn){
    const wrap = openBtn.parentElement;
    const input = wrap.querySelector("input[type='file'][data-photoadd='1']");
    if(!input){
      showToast("å†™çœŸå…¥åŠ›ãŒè¦‹ã¤ã‹ã‚‰ãªã„â€¦");
      return;
    }
    input.click();
  }
});

document.addEventListener("change", async (e)=>{
  const input = e.target;
  if(!(input instanceof HTMLInputElement)) return;
  if(input.getAttribute("data-photoadd")!=="1") return;

  const sid = input.dataset.student;
  const lkey = input.dataset.lesson;
  const gid = input.dataset.group;

  const files = Array.from(input.files || []);
  if(files.length===0) return;

  const rec = ensureGroup(sid, lkey, gid);
  for(const f of files){
    const dataUrl = await fileToCompressedDataUrl(f, 1600, 0.8);
    const id = makeId("ph");
    rec.photos = rec.photos || [];
    rec.photos.push({
      id,
      baseDataUrl: dataUrl,
      inkLayer: null,
      thumbDataUrl: null,
      createdAt: nowISO(),
    });
  }

  input.value = "";
  markDirty();
  renderAll();
  showToast(`${files.length}æš è¿½åŠ ã—ãŸ`);
});

/** =========================
 *  å…¥åŠ›ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆç‚¹æ•°ãƒ»é…ç‚¹ãƒ»ãƒã‚§ãƒƒã‚¯ãƒ»ãƒ¡ãƒ¢ï¼‰
 * ========================= */
document.addEventListener("input", (e)=>{
  const sid = state.currentStudentId;
  const lessonKey = state.currentLessonKey;
  const t = e.target;

  if(t.id==="unitName"){
    state.meta.unitName = t.value || "";
    document.getElementById("subTitle").textContent = `å˜å…ƒï¼š${state.meta.unitName || "â€”"}ï½œç«¯æœ«å†…ã«è‡ªå‹•ä¿å­˜`;
    markDirty();
    return;
  }

  if(t.id==="overallMemo"){
    if(!sid) return;
    const lesson = ensurePath(sid, lessonKey);
    if(!lesson.__overall) lesson.__overall = { memo:"" };
    lesson.__overall.memo = t.value || "";
    markDirty();
    return;
  }

  if(t instanceof HTMLInputElement && t.getAttribute("data-partscore")==="1"){
    if(!sid) return;
    const gid = t.dataset.group;
    const idx = Number(t.dataset.idx);

    const groups = getLessonGroups(lessonKey);
    const g = groups.find(x=>x.id===gid);
    if(!g || g.scoring?.type!=="subsum") return;

    const rec = ensureGroup(sid, lessonKey, gid);
    rec.parts = rec.parts || [];

    let v = (t.value || "").replace(/[^\d]/g,"");
    let n = v==="" ? 0 : Number(v);
    if(!Number.isFinite(n)) n = 0;

    const pmax = (g.scoring.parts?.[idx]?.max ?? 0);
    n = Math.max(0, Math.min(pmax, n));

    rec.parts[idx] = n;
    t.value = String(n);

    updateSavedGrade(sid, lessonKey, gid);
    markDirty();
    updateTotalsUI();
    renderRosterList();
    renderRubric();
    return;
  }

  if(t instanceof HTMLInputElement && t.getAttribute("data-score")==="1"){
    if(!sid) return;
    const gid = t.dataset.group;
    const groups = getLessonGroups(lessonKey);
    const g = groups.find(x=>x.id===gid);
    if(!g) return;

    const rec = ensureGroup(sid, lessonKey, gid);
    let v = t.value.replace(/[^\d]/g,"");
    if(v===""){ rec.score=null; updateSavedGrade(sid, lessonKey, gid); markDirty(); updateTotalsUI(); renderRosterList(); renderRubric(); return; }
    let n = Number(v);
    if(!Number.isFinite(n)) n=0;
    n = Math.max(0, Math.min(g.scoring.max, n));
    rec.score = n;
    if(String(n)!==t.value) t.value = n;

    updateSavedGrade(sid, lessonKey, gid);
    markDirty();
    updateTotalsUI();
    renderRosterList();
    renderRubric();
    return;
  }

  if(t instanceof HTMLTextAreaElement && t.getAttribute("data-memo")==="1"){
    if(!sid) return;
    const gid = t.dataset.group;
    const rec = ensureGroup(sid, lessonKey, gid);
    rec.memo = t.value || "";
    markDirty();
    return;
  }
});

document.addEventListener("change", (e)=>{
  const t = e.target;

  if(t.id==="lessonKey"){
    state.currentLessonKey = t.value;
    state.currentItemGroupId = "";
    markDirty();
    renderAll();
    return;
  }

  if(t.id==="itemGroupSelect"){
    state.currentItemGroupId = t.value;
    markDirty();
    renderAll();
    return;
  }

  const sid = state.currentStudentId;
  if(!sid) return;

  const lessonKey = state.currentLessonKey;

  if(t instanceof HTMLInputElement && t.getAttribute("data-check")==="1"){
    const gid = t.dataset.group;
    const idx = Number(t.dataset.idx);
    const rec = ensureGroup(sid, lessonKey, gid);
    rec.checks = rec.checks || [];
    rec.checks[idx] = t.checked;

    updateSavedGrade(sid, lessonKey, gid);
    markDirty();
    updateTotalsUI();
    renderRosterList();
    renderRubric();
    return;
  }
});

/** =========================
 *  ãƒŠãƒ“ãƒ»åç°¿åæ˜ ï¼ˆIDä¿æŒï¼‰
 * ========================= */
document.getElementById("btnApplyRoster").addEventListener("click", ()=>{
  const text = document.getElementById("rosterText").value || "";
  const lines = text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);

  const oldByName = new Map((state.roster||[]).map(s=>[s.name, s.id]));
  const roster = lines.map(name=>({ id: oldByName.get(name) || makeId("st"), name }));

  state.roster = roster;
  if(!state.currentStudentId && roster.length>0) state.currentStudentId = roster[0].id;

  markDirty();
  renderAll();
  showToast("åç°¿ã‚’åæ˜ ã—ãŸ");
});

document.getElementById("btnPrev").addEventListener("click", ()=>{
  if(state.roster.length===0) return;
  const idx = state.roster.findIndex(s=>s.id===state.currentStudentId);
  const n = (idx<=0) ? state.roster.length-1 : idx-1;
  state.currentStudentId = state.roster[n].id;
  markDirty();
  renderAll();
});
document.getElementById("btnNext").addEventListener("click", ()=>{
  if(state.roster.length===0) return;
  const idx = state.roster.findIndex(s=>s.id===state.currentStudentId);
  const n = (idx<0 || idx===state.roster.length-1) ? 0 : idx+1;
  state.currentStudentId = state.roster[n].id;
  markDirty();
  renderAll();
});

document.getElementById("btnMode").addEventListener("click", ()=>{
  state.uiMode = (state.uiMode === "student") ? "item" : "student";
  markDirty();
  renderAll();
});

document.getElementById("btnExportCSV").addEventListener("click", exportCSV);

document.getElementById("btnTheme").addEventListener("click", ()=>{
  const cur = document.documentElement.getAttribute("data-theme") || "light";
  applyTheme(cur === "dark" ? "light" : "dark");
});

/** =========================
 *  ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼å¾©å…ƒï¼å…¨æ¶ˆå»
 * ========================= */
document.getElementById("btnBackup").addEventListener("click", ()=>{
  const blob = new Blob([JSON.stringify(state,null,2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `sci_eval_backup_${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  URL.revokeObjectURL(a.href);
  showToast("ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’æ›¸ãå‡ºã—ãŸ");
});
document.getElementById("btnRestore").addEventListener("click", ()=>{
  const input = document.createElement("input");
  input.type="file";
  input.accept="application/json";
  input.onchange = async ()=>{
    const f = input.files?.[0];
    if(!f) return;
    const text = await f.text();
    try{
      const obj = JSON.parse(text);
      if(!obj || typeof obj !== "object") throw new Error("invalid");
      state = obj;
      if(!state.currentLessonKey) state.currentLessonKey = CONFIG.lessons[0].key;
      if(!state.uiMode) state.uiMode = "student";
      if(!state.currentItemGroupId) state.currentItemGroupId = "";
      markDirty();
      renderAll();
      showToast("å¾©å…ƒã—ãŸ");
    }catch{
      showToast("å¾©å…ƒã«å¤±æ•—ï¼ˆJSONãŒä¸æ­£ï¼‰");
    }
  };
  input.click();
});
document.getElementById("btnReset").addEventListener("click", async ()=>{
  if(!confirm("ç«¯æœ«å†…ã®è¨˜éŒ²ã‚’ã™ã¹ã¦æ¶ˆã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
  await idbDel(STATE_KEY);
  state = {
    meta:{ unitName: CONFIG.unitDefault, updatedAt: nowISO() },
    roster: [],
    currentStudentId: "",
    currentLessonKey: CONFIG.lessons[0].key,
    uiMode:"student",
    currentItemGroupId:"",
    records: {},
  };
  renderAll();
  showToast("å…¨æ¶ˆå»ã—ã¾ã—ãŸ");
});

/** =========================
 *  ç”»é¢æ›´æ–°
 * ========================= */
function updateTotalsUI(){
  const sid = state.currentStudentId;
  if(!sid){
    document.getElementById("sumK").textContent="0";
    document.getElementById("sumT").textContent="0";
    document.getElementById("sumA").textContent="0";
    document.getElementById("sumAll").textContent="0";
    document.getElementById("gradeAll").textContent="â€”";
    document.getElementById("gradeAll").className="grade B";
    document.getElementById("who").textContent="â€”";
    return;
  }

  const totals = calcTotals(sid, state.currentLessonKey);
  document.getElementById("sumK").textContent = totals.sumK;
  document.getElementById("sumT").textContent = totals.sumT;
  document.getElementById("sumA").textContent = totals.sumA;
  document.getElementById("sumAll").textContent = `${totals.sumAll}/${totals.maxAll}`;
  const g = document.getElementById("gradeAll");
  g.textContent = totals.grade;
  g.className = "grade " + gradeClass(totals.grade);

  document.getElementById("who").textContent = `${studentNameById(sid)}ï½œ${lessonNameByKey(state.currentLessonKey)}`;
}

function renderAll(){
  document.getElementById("unitName").value = state.meta.unitName || "";
  document.getElementById("subTitle").textContent = `å˜å…ƒï¼š${state.meta.unitName || "â€”"}ï½œç«¯æœ«å†…ã«è‡ªå‹•ä¿å­˜`;

  renderLessonSelect();

  const sid = state.currentStudentId;
  if(sid){
    const lesson = ensurePath(sid, state.currentLessonKey);
    const memo = lesson.__overall?.memo || "";
    const ta = document.getElementById("overallMemo");
    ta.value = memo;

    setTimeout(()=>{
      const lkey = state.currentLessonKey;
      bindMemoHeightOnce(ta, "overall", sid, lkey, "__overall", 120);
    }, 0);
  }else{
    document.getElementById("overallMemo").value = "";
  }

  renderRosterList();

  const btnMode = document.getElementById("btnMode");
  btnMode.textContent = (state.uiMode==="student") ? "è¡¨ç¤ºï¼šé …ç›®ã¸" : "è¡¨ç¤ºï¼šå…ç«¥ã¸";

  document.getElementById("itemModePanel").style.display = (state.uiMode==="item") ? "block" : "none";
  document.getElementById("rubric").style.display = (state.uiMode==="student") ? "block" : "none";

  if(state.uiMode==="student") renderRubric();
  else renderItemMode();

  updateTotalsUI();
}

/** =========================
 *  èµ·å‹•
 * ========================= */
(async function init(){
  initTheme();

  await openDB();
  const saved = await idbGet(STATE_KEY);
  if(saved){
    state = saved;
    if(!state.currentLessonKey) state.currentLessonKey = CONFIG.lessons[0].key;
    if(!state.uiMode) state.uiMode = "student";
    if(!state.currentItemGroupId) state.currentItemGroupId = "";
  }else{
    state.roster = [
      {id:makeId("st"), name:"3å¹´A å…ç«¥A"},
      {id:makeId("st"), name:"3å¹´A å…ç«¥B"},
    ];
    state.currentStudentId = state.roster[0].id;
    state.meta.unitName = CONFIG.unitDefault;
    await idbSet(STATE_KEY, state);
  }

  for(const st of (state.roster||[])){
    for(const l of (CONFIG.lessons||[])){
      const groups = getLessonGroups(l.key);
      for(const g of groups){
        if(state.records?.[st.id]?.[l.key]?.[g.id]){
          updateSavedGrade(st.id, l.key, g.id);
        }
      }
    }
  }
  await idbSet(STATE_KEY, state);

  document.getElementById("rosterText").value = state.roster.map(s=>s.name).join("\n");
  renderAll();
  showToast("èµ·å‹•ã—ã¾ã—ãŸ");
})();
</script>
</body>
</html>
