<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <title>理科評価 記録ツール（iPad）</title>
  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --card2:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --shadow: 0 10px 26px rgba(0,0,0,.10);
      --radius:18px;

      --k:#0ea5e9;  /* 知識・技能 */
      --t:#6366f1;  /* 思考・判断・表現 */
      --a:#f59e0b;  /* 主体的 */
      --danger:#ef4444;
      --ok:#10b981;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Hiragino Sans", "Noto Sans JP", "Segoe UI", Arial;
      background: var(--bg);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      touch-action:manipulation;
    }
    button, input, textarea, select { font: inherit; color:inherit; }
    a{color:inherit}
    .safe{padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);}
    .app{
      min-height:100%;
      display:flex;
      flex-direction:column;
    }

    header{
      position:sticky; top:0; z-index:50;
      background: rgba(255,255,255,.82);
      backdrop-filter: blur(10px);
      border-bottom:1px solid rgba(0,0,0,.08);
    }
    .topbar{
      padding:14px 14px 10px;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .title{
      display:flex; flex-direction:column; gap:2px;
    }
    .title b{font-size:16px}
    .title small{color:var(--muted); font-size:12px}

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 12px;
      border-radius:999px;
      background: rgba(255,255,255,.9);
      border:1px solid rgba(0,0,0,.10);
      box-shadow: 0 8px 20px rgba(0,0,0,.08);
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .pill strong{font-size:14px}
    .pill .dot{width:10px;height:10px;border-radius:999px;background:var(--ok)}

    .actions{display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end}
    .btn{
      border:none;
      border-radius:14px;
      padding:12px 14px;
      background: rgba(255,255,255,.92);
      border:1px solid rgba(0,0,0,.10);
      box-shadow: var(--shadow);
      cursor:pointer;
      min-height:44px;
      -webkit-tap-highlight-color: transparent;
      user-select:none;
    }
    .btn:active{transform: translateY(1px)}
    .btn.primary{background: rgba(99,102,241,.10); border-color: rgba(99,102,241,.25)}
    .btn.warn{background: rgba(245,158,11,.10); border-color: rgba(245,158,11,.25)}
    .btn.danger{background: rgba(239,68,68,.10); border-color: rgba(239,68,68,.25)}
    .btn.ok{background: rgba(16,185,129,.10); border-color: rgba(16,185,129,.25)}
    .btn.small{padding:10px 12px; border-radius:12px; font-size:13px}
    .btn.ghost{background: transparent; box-shadow:none}

    .row{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }

    main{
      flex:1;
      padding:14px 14px 120px;
      max-width:1100px;
      width:100%;
      margin:0 auto;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    @media (min-width: 940px){
      .grid{grid-template-columns: 360px 1fr;}
    }

    .card{
      background: var(--card);
      border:1px solid rgba(0,0,0,.10);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card h3{
      margin:0;
      padding:14px 14px 10px;
      font-size:14px;
      color:var(--muted);
      border-bottom:1px solid rgba(0,0,0,.08);
      background: rgba(0,0,0,.02);
      display:flex; align-items:center; justify-content:space-between; gap:8px;
    }
    .card .body{padding:14px}
    .muted{color:var(--muted)}
    .split{
      display:flex; gap:10px; flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    .field{
      display:flex; flex-direction:column; gap:6px;
    }
    .field label{font-size:12px; color:var(--muted)}
    .input, textarea{
      background: rgba(255,255,255,.95);
      border:1px solid rgba(0,0,0,.12);
      border-radius: 14px;
      padding:12px 12px;
      min-height:44px;
      outline:none;
    }
    textarea{min-height:72px; resize:vertical;}
    .select{
      background: rgba(255,255,255,.95);
      border:1px solid rgba(0,0,0,.12);
      border-radius: 14px;
      padding:12px 12px;
      min-height:44px;
    }

    .list{
      display:flex; flex-direction:column; gap:10px;
    }
    .student{
      padding:12px 12px;
      border-radius:16px;
      border:1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.95);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      user-select:none;
    }
    .student.active{
      background: rgba(99,102,241,.08);
      border-color: rgba(99,102,241,.25);
    }
    .student b{font-size:15px}
    .badge{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.92);
      font-size:12px;
      display:inline-flex; align-items:center; gap:6px;
      user-select:none;
    }
    .badge .s{font-weight:700}
    .badge.k{border-color: rgba(14,165,233,.35); background: rgba(14,165,233,.08)}
    .badge.t{border-color: rgba(99,102,241,.35); background: rgba(99,102,241,.08)}
    .badge.a{border-color: rgba(245,158,11,.35); background: rgba(245,158,11,.08)}
    .badge.total{border-color: rgba(0,0,0,.14); background: rgba(0,0,0,.03)}

    .grade{
      font-weight:800;
      padding:6px 10px;
      border-radius:12px;
      border:1px solid rgba(0,0,0,.12);
      min-width:44px;
      text-align:center;
      background: rgba(255,255,255,.95);
    }
    .grade.A{background: rgba(16,185,129,.10); border-color: rgba(16,185,129,.25)}
    .grade.Bp{background: rgba(14,165,233,.10); border-color: rgba(14,165,233,.25)}
    .grade.B{background: rgba(0,0,0,.03); border-color: rgba(0,0,0,.14)}
    .grade.Bm{background: rgba(245,158,11,.10); border-color: rgba(245,158,11,.25)}
    .grade.C{background: rgba(239,68,68,.10); border-color: rgba(239,68,68,.25)}

    .rubric{
      display:flex; flex-direction:column; gap:12px;
    }
    details{
      border-radius: 16px;
      border:1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.95);
      overflow:hidden;
    }
    summary{
      list-style:none;
      padding:12px 12px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      background: rgba(0,0,0,.02);
      border-bottom:1px solid rgba(0,0,0,.06);
    }
    summary::-webkit-details-marker{display:none}
    .sumL{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
    .tag{
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      border:1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.92);
      user-select:none;
    }
    .tag.k{border-color: rgba(14,165,233,.35); background: rgba(14,165,233,.08)}
    .tag.t{border-color: rgba(99,102,241,.35); background: rgba(99,102,241,.08)}
    .tag.a{border-color: rgba(245,158,11,.35); background: rgba(245,158,11,.08)}
    .tag.gray{border-color: rgba(0,0,0,.14); background: rgba(0,0,0,.03)}
    .sumR{display:flex; align-items:center; gap:8px; flex-wrap:wrap; justify-content:flex-end}
    .mini{font-size:12px;color:var(--muted)}
    .line{height:1px;background: rgba(0,0,0,.08); margin:10px 0}
    .block{padding:12px}
    .scoreRow{
      display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap;
      justify-content:space-between;
    }
    .scoreBox{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }
    .num{
      width:110px;
      text-align:center;
      font-weight:800;
      font-size:18px;
      letter-spacing:.5px;
    }
    .hint{font-size:12px;color:var(--muted)}
    .itemCard{
      border-radius: 16px;
      border:1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.95);
      padding:12px;
      display:flex; flex-direction:column; gap:10px;
    }

    .photoArea{
      display:flex; flex-direction:column; gap:10px;
    }
    .photoStrip{
      display:flex; gap:10px; flex-wrap:wrap;
    }
    .thumb{
      width:110px; height:90px;
      border-radius: 14px;
      border:1px solid rgba(0,0,0,.12);
      background: rgba(0,0,0,.03);
      overflow:hidden;
      position:relative;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .thumb img{
      width:100%; height:100%; object-fit:cover;
      display:block;
    }
    .thumb .x{
      position:absolute; top:6px; right:6px;
      width:26px; height:26px; border-radius:999px;
      border:none;
      background: rgba(255,255,255,.88);
      border:1px solid rgba(0,0,0,.12);
      cursor:pointer;
    }
    .thumb .x:active{transform:translateY(1px)}
    .thumb .ocr{
      position:absolute; bottom:6px; left:6px;
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      background: rgba(255,255,255,.88);
      border:1px solid rgba(0,0,0,.12);
      user-select:none;
    }

    /* モーダル */
    .modal{
      position:fixed; inset:0;
      background: rgba(0,0,0,.45);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:100;
      padding: 14px;
    }
    .modal.show{display:flex}
    .modalCard{
      width:min(980px, 100%);
      max-height: 92vh;
      border-radius: 18px;
      border:1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.96);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .modalTop{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:12px 12px;
      border-bottom:1px solid rgba(0,0,0,.10);
      background: rgba(0,0,0,.02);
      flex-wrap:wrap;
    }
    .modalTop .left{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .modalTop .right{display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end}
    .canvasWrap{
      position:relative;
      background: rgba(0,0,0,.03);
      flex:1;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      padding:10px;
    }
    .stage{
      position:relative;
      border-radius: 14px;
      overflow:hidden;
      border:1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.96);
    }
    .stage img{display:block; max-width: 100%; height:auto}
    canvas{
      position:absolute; left:0; top:0;
      touch-action: none;
    }
    .toolRow{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
    }
    .toolRow .lab{font-size:12px;color:var(--muted)}
    .range{width:140px}

    .toast{
      position:fixed;
      left:50%;
      bottom: calc(18px + env(safe-area-inset-bottom));
      transform: translateX(-50%);
      background: rgba(0,0,0,.72);
      color:white;
      border:1px solid rgba(255,255,255,.18);
      border-radius:999px;
      padding:10px 14px;
      font-size:13px;
      display:none;
      z-index:200;
      max-width: calc(100% - 20px);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .toast.show{display:block}

    footer{
      position:fixed;
      left:0; right:0; bottom:0;
      padding:10px 12px calc(10px + env(safe-area-inset-bottom));
      background: rgba(255,255,255,.86);
      border-top:1px solid rgba(0,0,0,.08);
      backdrop-filter: blur(10px);
      z-index:40;
    }
    .foot{
      max-width:1100px;
      margin:0 auto;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .statline{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      color:var(--muted);
      font-size:12px;
    }

    /* 項目モード */
    .itemRow{
      padding:12px;
      border-radius:16px;
      border:1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.95);
      display:flex;
      gap:10px;
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .smallChecks{
      display:flex; gap:6px; flex-wrap:wrap; align-items:center;
    }
    .smallChecks input{ width:22px; height:22px; }
  </style>
</head>

<body>
<div class="app safe">
  <header>
    <div class="topbar">
      <div class="title">
        <b>理科評価 記録ツール（iPad最適化）</b>
        <small id="subTitle">単元：電気の通り道（サンプル）｜端末内に自動保存</small>
      </div>
      <div class="actions">
        <button class="btn small" id="btnMode">表示：児童</button>
        <button class="btn small primary" id="btnBackup">バックアップ(JSON)</button>
        <button class="btn small warn" id="btnRestore">復元(JSON)</button>
        <button class="btn small danger" id="btnReset">全消去</button>
      </div>
    </div>
  </header>

  <main>
    <div class="grid">
      <!-- 左：名簿 -->
      <section class="card">
        <h3>
          <span>名簿</span>
          <span class="mini">タップで切替</span>
        </h3>
        <div class="body">
          <div class="field">
            <label>児童名（改行で複数）</label>
            <textarea id="rosterText" placeholder="例）&#10;3-1 田中太郎&#10;3-1 佐藤花子"></textarea>
          </div>
          <div class="row" style="margin-top:10px; justify-content:flex-end;">
            <button class="btn ok" id="btnApplyRoster">名簿を反映</button>
          </div>

          <div class="line"></div>

          <div class="list" id="studentList"></div>
        </div>
      </section>

      <!-- 右：採点 -->
      <section class="card">
        <h3>
          <span>採点</span>
          <span class="mini" id="who">—</span>
        </h3>
        <div class="body">
          <div class="split">
            <div class="field" style="flex:1; min-width:260px;">
              <label>単元名</label>
              <input class="input" id="unitName" placeholder="例：電気の通り道" />
            </div>
            <div class="field" style="min-width:220px;">
              <label>授業回（記録用）</label>
              <select class="select" id="lessonKey"></select>
            </div>
          </div>

          <div class="line"></div>

          <div class="split">
            <div class="row">
              <span class="badge k"><span class="s">知識・技能</span> <span id="sumK">0</span></span>
              <span class="badge t"><span class="s">思考・判断・表現</span> <span id="sumT">0</span></span>
              <span class="badge a"><span class="s">主体的</span> <span id="sumA">0</span></span>
              <span class="badge total"><span class="s">合計</span> <span id="sumAll">0</span></span>
            </div>
            <div class="row">
              <span class="grade B" id="gradeAll">—</span>
            </div>
          </div>

          <div class="line"></div>

          <!-- 項目モード（A） -->
          <div id="itemModePanel" style="display:none;">
            <div class="field">
              <label>項目を選択（この項目を全員分まとめて入力）</label>
              <select class="select" id="itemGroupSelect"></select>
            </div>
            <div class="line"></div>
            <div id="itemList" class="list"></div>
            <div class="line"></div>
          </div>

          <!-- 児童モード -->
          <div class="rubric" id="rubric"></div>

          <div class="line"></div>

          <div class="field">
            <label>全体メモ（この児童・この授業回）</label>
            <textarea id="overallMemo" placeholder="気づき、声かけ、次時の手立て など"></textarea>
          </div>
        </div>
      </section>
    </div>
  </main>

  <footer>
    <div class="foot">
      <div class="statline" id="statusLine">
        <span class="pill"><span class="dot" id="dot"></span><strong id="saveState">保存OK</strong></span>
        <span>※ホーム画面追加で安定（iPad Safari推奨）</span>
      </div>
      <div class="row">
        <button class="btn small" id="btnPrev">◀ 前の児童</button>
        <button class="btn small" id="btnNext">次の児童 ▶</button>
      </div>
    </div>
  </footer>

  <!-- 注釈モーダル -->
  <div class="modal" id="modal">
    <div class="modalCard">
      <div class="modalTop">
        <div class="left">
          <span class="tag gray" id="modalTitle">写真注釈</span>
          <span class="mini" id="modalSub">—</span>
        </div>
        <div class="right">
          <div class="toolRow">
            <span class="lab">色</span>
            <input type="color" id="penColor" value="#ef4444" />
          </div>
          <div class="toolRow">
            <span class="lab">太さ</span>
            <input class="range" type="range" id="penSize" min="1" max="28" value="6" />
            <span class="mini" id="penSizeVal">6</span>
          </div>

          <button class="btn small" id="toolPen">ペン</button>
          <button class="btn small warn" id="toolEraser">消しゴム</button>
          <button class="btn small danger" id="toolObjEraser">オブジェクト消し</button>

          <button class="btn small" id="toolLine">／</button>
          <button class="btn small" id="toolArrow">→</button>
          <button class="btn small" id="toolRect">□</button>
          <button class="btn small" id="toolCircle">○</button>
          <button class="btn small" id="toolEllipse">◯</button>
          <button class="btn small" id="toolTri">△</button>

          <button class="btn small" id="toolText">T</button>
          <button class="btn small" id="btnUndo">戻す</button>
          <button class="btn small" id="btnClearInk">注釈全消し</button>
          <button class="btn small ok" id="btnSaveInk">保存</button>
          <button class="btn small ghost" id="btnClose">閉じる</button>
        </div>
      </div>

      <div class="canvasWrap" id="canvasWrap">
        <div class="stage" id="stage">
          <img id="baseImg" alt="photo" />
          <canvas id="ink"></canvas>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>
</div>

<script>
/** =========================
 *  1) 設定（後で評価計画に合わせてここを調整）
 * ========================= */
const CONFIG = {
  unitDefault: "電気の通り道",
  lessons: [
    { key:"L1", name:"第1-2時：回路（理解・技能）" },
    { key:"L2", name:"第2時：シンキング（つく/つかない）軽め10点" },
    { key:"L3", name:"第3-5時：通す/通さない（技能+思考+主体）" },
    { key:"L7", name:"第7時：空き缶は通す？（発展・10点）" },
    { key:"L8", name:"第8時：まとめテスト" },
  ],
  domains: {
    K: { label:"知識・技能", color:"var(--k)" },
    T: { label:"思考・判断・表現", color:"var(--t)" },
    A: { label:"主体的", color:"var(--a)" },
  },

  // B帯を広げた判定（合計満点に対する割合）
  gradeBands: {
    A: 0.86,   // 86%以上
    Bp:0.72,   // 72%以上
    B: 0.40,   // 40%以上（B広め）
    Bm:0.28,   // 28%以上
    C: 0.00
  },

  rubricByLesson: {
    L1: [
      {
        id:"K_L1",
        domain:"K",
        title:"回路の技能（チェック：達成数）",
        scoring:{ type:"checkCount", max:5 },
        criteria:[
          "乾電池の＋極/−極を意識してつなぐ",
          "豆電球をソケットにしっかり固定できる",
          "導線のつなぎが確実（外れない）",
          "安全（ショート等に注意）",
          "結果を記録（簡単にでも）",
        ],
      },
      {
        id:"T_L1",
        domain:"T",
        title:"予想（回路図＋理由）※正解でなくてOK（10点）",
        scoring:{ type:"manual", max:10 },
        criteria:[
          "回路図が“輪”として描けている",
          "電池の極や豆電球のつながりが分かる図",
          "理由が自分の言葉で書けている（視点がある）",
          "丁寧さ・説明の分かりやすさ",
        ],
      },
    ],
    L2: [
      {
        id:"T_L2",
        domain:"T",
        title:"シンキングツール（つく/つかない）からの軽い考察（10点）",
        scoring:{ type:"manual", max:10 },
        criteria:[
          "結果をシンキングに正しく整理できている",
          "整理から気づき（共通点/ちがい）を言えている",
          "言葉で説明できている",
        ],
      },
      {
        id:"K_L2",
        domain:"K",
        title:"知識・技能（チェック：2つだけ）",
        scoring:{ type:"checkCount", max:2 },
        criteria:[
          "用語（乾電池/導線/豆電球/ソケット等）が言える",
          "回路が“輪”になると電気が通ると説明できる",
        ],
      },
    ],
    L3: [
      {
        id:"K_L3",
        domain:"K",
        title:"分類実験の技能（シビア版：チェック数）",
        scoring:{ type:"checkCount", max:5 },
        criteria:[
          "テスターの動作確認を先にできる",
          "導線の当て方が確実（接触不良を減らす）",
          "塗装等を避けて金属部分に当てられる",
          "結果をその場で正確に記録できる",
          "同じ条件で再確認（誤差チェック）ができる",
        ],
      },
      {
        id:"T_L3a",
        domain:"T",
        title:"予想（10点）",
        scoring:{ type:"manual", max:10 },
        criteria:[
          "予想＋理由（材質などの視点）",
        ],
      },
      {
        id:"T_L3b",
        domain:"T",
        title:"シンキング→分析→表現→結論（15点：結論重視）",
        scoring:{ type:"manual", max:15 },
        criteria:[
          "結果をシンキングにまとめられる",
          "シンキングから分析（共通点/規則性）",
          "分析を言葉で表現できる",
          "自分なりの結論を導けている（ここ重視）",
        ],
      },
      {
        id:"A_L3",
        domain:"A",
        title:"主体：リクエスト（3個以上でB）",
        scoring:{ type:"manual", max:5 },
        criteria:[
          "調べたい物を3個以上リクエストできたか（量）",
          "理由や視点があるか（質）",
        ],
      },
    ],
    L7: [
      {
        id:"T_L7",
        domain:"T",
        title:"空き缶は本当は通すはず…なのに通らないのはなぜ？（発展・10点）",
        scoring:{ type:"manual", max:10 },
        criteria:[
          "『中は金属』など本質に触れている",
          "表面の塗装/コーティングに気づけている",
          "自分の言葉で筋道立てて説明できる",
        ],
      }
    ],
    L8: [
      {
        id:"K_L8",
        domain:"K",
        title:"まとめテスト（得点入力）",
        scoring:{ type:"manual", max:100 },
        criteria:[
          "得点を入力（必要なら別途換算）",
        ],
      }
    ]
  },

  // 主体（8時間通し）
  attitudeAcross: [
    {
      id:"A_ALL1",
      domain:"A",
      title:"振り返りの蓄積（いつでも記録OK）",
      scoring:{ type:"manual", max:10 },
      criteria:[
        "振り返りが積み上がっている（回数/質）",
        "学びの言語化が進んでいる"
      ],
      note:"※毎回書けない前提。空欄でもOK、記録は柔軟に。"
    },
    {
      id:"A_ALL2",
      domain:"A",
      title:"授業中の様子（安全配慮/学習へ向かう/忘れ物等）",
      scoring:{ type:"manual", max:10 },
      criteria:[
        "安全に配慮している",
        "学習へ向かおうとしている",
        "忘れ物/提出など",
      ],
    }
  ],
};

/** =========================
 *  2) IndexedDB（端末内保存）
 * ========================= */
const DB_NAME = "SciEvalDB_v2";
const DB_VER = 1;
const STORE = "state";

let db = null;
function openDB(){
  return new Promise((resolve,reject)=>{
    const req = indexedDB.open(DB_NAME, DB_VER);
    req.onupgradeneeded = ()=>{
      const d = req.result;
      if(!d.objectStoreNames.contains(STORE)){
        d.createObjectStore(STORE);
      }
    };
    req.onsuccess=()=>{ db=req.result; resolve(db); };
    req.onerror=()=>reject(req.error);
  });
}
function idbGet(key){
  return new Promise((resolve,reject)=>{
    const tx=db.transaction(STORE,"readonly");
    const st=tx.objectStore(STORE);
    const req=st.get(key);
    req.onsuccess=()=>resolve(req.result);
    req.onerror=()=>reject(req.error);
  });
}
function idbSet(key,val){
  return new Promise((resolve,reject)=>{
    const tx=db.transaction(STORE,"readwrite");
    const st=tx.objectStore(STORE);
    const req=st.put(val,key);
    req.onsuccess=()=>resolve(true);
    req.onerror=()=>reject(req.error);
  });
}
function idbDel(key){
  return new Promise((resolve,reject)=>{
    const tx=db.transaction(STORE,"readwrite");
    const st=tx.objectStore(STORE);
    const req=st.delete(key);
    req.onsuccess=()=>resolve(true);
    req.onerror=()=>reject(req.error);
  });
}

/** =========================
 *  3) 状態
 * ========================= */
const STATE_KEY = "app_state";
const nowISO = ()=> new Date().toISOString();

let state = {
  meta:{
    unitName: CONFIG.unitDefault,
    updatedAt: nowISO(),
  },
  roster: [],
  currentStudentId: "",
  currentLessonKey: CONFIG.lessons[0].key,

  uiMode: "student",        // "student" | "item"
  currentItemGroupId: "",   // 項目モードで表示中のgroup

  records: {}, // records[studentId][lessonKey][groupId] = { score, checks[], memo, photos[] }
};

function makeId(prefix="id"){
  return prefix + "_" + Math.random().toString(36).slice(2,9) + "_" + Date.now().toString(36);
}
function ensurePath(studentId, lessonKey){
  if(!state.records[studentId]) state.records[studentId] = {};
  if(!state.records[studentId][lessonKey]) state.records[studentId][lessonKey] = {};
  return state.records[studentId][lessonKey];
}
function ensureGroup(studentId, lessonKey, groupId){
  const lesson = ensurePath(studentId, lessonKey);
  if(!lesson[groupId]){
    lesson[groupId] = { score:null, checks:[], memo:"", photos:[] };
  }
  return lesson[groupId];
}

let saveTimer = null;
function markDirty(){
  state.meta.updatedAt = nowISO();
  const dot = document.getElementById("dot");
  dot.style.background = "var(--danger)";
  document.getElementById("saveState").textContent="保存中…";
  if(saveTimer) clearTimeout(saveTimer);
  saveTimer = setTimeout(async ()=>{
    await idbSet(STATE_KEY, state);
    dot.style.background = "var(--ok)";
    document.getElementById("saveState").textContent="保存OK";
  }, 220);
}

function showToast(msg){
  const t=document.getElementById("toast");
  t.textContent=msg;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"), 1800);
}

function escapeHtml(s){
  return (s??"").toString()
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#39;");
}

function gradeFromRatio(r){
  const b = CONFIG.gradeBands;
  if(r >= b.A) return "A";
  if(r >= b.Bp) return "B+";
  if(r >= b.B) return "B";
  if(r >= b.Bm) return "B-";
  return "C";
}
function gradeClass(g){
  if(g==="A") return "A";
  if(g==="B+") return "Bp";
  if(g==="B") return "B";
  if(g==="B-") return "Bm";
  if(g==="C") return "C";
  return "B";
}

function getLessonGroups(lessonKey){
  const base = CONFIG.rubricByLesson[lessonKey] ? [...CONFIG.rubricByLesson[lessonKey]] : [];
  return [...base, ...CONFIG.attitudeAcross];
}

function calcTotals(studentId, lessonKey){
  const groups = getLessonGroups(lessonKey);
  let sumK=0, sumT=0, sumA=0, sumAll=0;
  let maxAll=0;

  for(const g of groups){
    const rec = ensureGroup(studentId, lessonKey, g.id);
    const max = g.scoring?.max ?? 0;
    maxAll += max;

    let points = 0;
    if(g.scoring?.type === "checkCount"){
      const cnt = (rec.checks || []).filter(Boolean).length;
      points = Math.min(max, cnt);
    }else{
      points = (rec.score==null || rec.score==="") ? 0 : Number(rec.score);
      if(!Number.isFinite(points)) points=0;
      points = Math.max(0, Math.min(max, points));
    }

    sumAll += points;
    if(g.domain==="K") sumK += points;
    if(g.domain==="T") sumT += points;
    if(g.domain==="A") sumA += points;
  }

  const ratio = maxAll>0 ? sumAll/maxAll : 0;
  const grade = gradeFromRatio(ratio);
  return {sumK, sumT, sumA, sumAll, maxAll, grade};
}

function renderLessonSelect(){
  const sel = document.getElementById("lessonKey");
  sel.innerHTML = CONFIG.lessons.map(l=>`<option value="${escapeHtml(l.key)}">${escapeHtml(l.name)}</option>`).join("");
  sel.value = state.currentLessonKey;
}

function studentNameById(id){
  const st = state.roster.find(s=>s.id===id);
  return st ? st.name : "—";
}
function lessonNameByKey(k){
  const l = CONFIG.lessons.find(x=>x.key===k);
  return l ? l.name : k;
}

/** =========================
 *  4) 名簿表示
 * ========================= */
function renderRosterList(){
  const list = document.getElementById("studentList");
  list.innerHTML = "";

  if(state.roster.length===0){
    const div=document.createElement("div");
    div.className="muted";
    div.textContent="名簿を入力して「名簿を反映」してください。";
    list.appendChild(div);
    return;
  }

  for(const st of state.roster){
    const btn=document.createElement("div");
    btn.className="student" + (st.id===state.currentStudentId ? " active":"");
    const totals = calcTotals(st.id, state.currentLessonKey);

    btn.innerHTML = `
      <div style="display:flex; flex-direction:column; gap:2px;">
        <b>${escapeHtml(st.name)}</b>
        <span class="mini">更新：${new Date(state.meta.updatedAt).toLocaleString()}</span>
      </div>
      <div style="display:flex; flex-direction:column; align-items:flex-end; gap:6px;">
        <span class="grade ${gradeClass(totals.grade)}">${escapeHtml(totals.grade)}</span>
        <span class="mini">${totals.sumAll}/${totals.maxAll}</span>
      </div>
    `;
    btn.addEventListener("click", ()=>{
      state.currentStudentId = st.id;
      markDirty();
      renderAll();
    });
    list.appendChild(btn);
  }
}

/** =========================
 *  5) 写真（無制限）＋注釈
 * ========================= */
function makePhotoBlock(studentId, lessonKey, groupId){
  const rec = ensureGroup(studentId, lessonKey, groupId);
  const photos = rec.photos || [];

  const wrap = document.createElement("div");
  wrap.className="photoArea";

  const top = document.createElement("div");
  top.style.display="flex";
  top.style.gap="8px";
  top.style.flexWrap="wrap";
  top.style.justifyContent="space-between";
  top.innerHTML = `
    <div class="mini">写真（無制限）｜サムネタップ＝注釈（ペン/図形）</div>
    <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; align-items:center;">
      <input type="file" accept="image/*" multiple style="display:none"
             data-photoadd="1"
             data-student="${escapeHtml(studentId)}"
             data-lesson="${escapeHtml(lessonKey)}"
             data-group="${escapeHtml(groupId)}">
      <button class="btn small" type="button"
              data-open-picker="1"
              data-student="${escapeHtml(studentId)}"
              data-lesson="${escapeHtml(lessonKey)}"
              data-group="${escapeHtml(groupId)}">＋ 写真を追加</button>
    </div>
  `;

  const strip = document.createElement("div");
  strip.className="photoStrip";

  for(const p of photos){
    const th = document.createElement("div");
    th.className="thumb";
    th.innerHTML = `
      <img src="${p.thumbDataUrl || p.baseDataUrl}" alt="thumb">
      <button class="x" type="button" title="削除">×</button>
      <div class="ocr">注釈</div>
    `;
    th.querySelector(".x").addEventListener("click", (e)=>{
      e.stopPropagation();
      rec.photos = (rec.photos||[]).filter(x=>x.id!==p.id);
      markDirty();
      renderAll();
    });
    th.addEventListener("click", ()=>{
      openAnnotator(studentId, lessonKey, groupId, p.id);
    });
    strip.appendChild(th);
  }

  wrap.appendChild(top);
  wrap.appendChild(strip);
  return wrap;
}

function fileToDataUrl(file){
  return new Promise((resolve,reject)=>{
    const r = new FileReader();
    r.onload=()=>resolve(r.result);
    r.onerror=()=>reject(r.error);
    r.readAsDataURL(file);
  });
}

/** =========================
 *  6) 児童モード（1人ずつ）
 * ========================= */
function renderRubric(){
  const wrap = document.getElementById("rubric");
  wrap.innerHTML = "";
  const sid = state.currentStudentId;
  if(!sid){
    wrap.innerHTML = `<div class="muted">名簿から児童を選ぶと採点できます。</div>`;
    return;
  }

  const lessonKey = state.currentLessonKey;
  const groups = getLessonGroups(lessonKey);

  for(const g of groups){
    const dom = CONFIG.domains[g.domain];
    const rec = ensureGroup(sid, lessonKey, g.id);

    const det = document.createElement("details");
    det.open = true;

    det.innerHTML = `
      <summary>
        <div class="sumL">
          <span class="tag ${g.domain==="K"?"k":g.domain==="T"?"t":"a"}">${escapeHtml(dom.label)}</span>
          <b style="font-size:14px;">${escapeHtml(g.title)}</b>
          ${g.note ? `<span class="tag gray">${escapeHtml(g.note)}</span>` : ""}
        </div>
        <div class="sumR">
          <span class="tag gray">${g.scoring?.max ?? 0}点</span>
        </div>
      </summary>
    `;

    const block = document.createElement("div");
    block.className="block";

    const scoreRow = document.createElement("div");
    scoreRow.className="scoreRow";

    const left = document.createElement("div");
    left.style.flex="1";
    left.style.minWidth="260px";

    const crit = (g.criteria||[]);
    const critHtml = crit.map((c, idx)=>{
      if(g.scoring?.type==="checkCount"){
        const checked = !!(rec.checks||[])[idx];
        return `
          <label style="display:flex; gap:10px; align-items:flex-start; margin:10px 0; cursor:pointer;">
            <input type="checkbox" data-check="1" data-group="${escapeHtml(g.id)}" data-idx="${idx}" ${checked?"checked":""}
                   style="width:22px; height:22px; margin-top:2px;">
            <span>${escapeHtml(c)}</span>
          </label>
        `;
      }
      return `
        <div style="display:flex; gap:10px; align-items:flex-start; margin:8px 0;">
          <span class="tag gray" style="min-width:34px; text-align:center;">${idx+1}</span>
          <span>${escapeHtml(c)}</span>
        </div>
      `;
    }).join("");

    left.innerHTML = `
      <div class="mini">基準（授業中に見ながら判断）</div>
      <div>${critHtml}</div>
    `;

    const right = document.createElement("div");
    right.style.minWidth="280px";
    right.style.display="flex";
    right.style.flexDirection="column";
    right.style.gap="10px";
    right.style.alignItems="stretch";

    let scoreUI = "";
    if(g.scoring?.type==="checkCount"){
      const cnt = (rec.checks||[]).filter(Boolean).length;
      scoreUI = `
        <div class="field">
          <label>達成数（自動）</label>
          <input class="input num" value="${cnt}" readonly />
          <div class="hint">チェック数＝得点（最大 ${g.scoring.max}）</div>
        </div>
      `;
    }else{
      const v = (rec.score==null) ? "" : rec.score;
      scoreUI = `
        <div class="field">
          <label>点数（0〜${g.scoring.max}）</label>
          <input class="input num" inputmode="numeric" pattern="[0-9]*" data-score="1" data-group="${escapeHtml(g.id)}"
                 value="${escapeHtml(v)}" placeholder="0" />
          <div class="hint">※あなたが入力</div>
        </div>
      `;
    }

    right.innerHTML = `
      ${scoreUI}
      <div class="field">
        <label>メモ（この項目）</label>
        <textarea data-memo="1" data-group="${escapeHtml(g.id)}" placeholder="見取り／声かけ／次の手立て">${escapeHtml(rec.memo||"")}</textarea>
      </div>
    `;

    scoreRow.appendChild(left);
    scoreRow.appendChild(right);

    const itemCard = document.createElement("div");
    itemCard.className="itemCard";
    itemCard.appendChild(scoreRow);
    itemCard.appendChild(makePhotoBlock(sid, lessonKey, g.id));

    block.appendChild(itemCard);
    det.appendChild(block);
    wrap.appendChild(det);
  }
}

/** =========================
 *  7) 項目モードA（項目1つ→全員分入力）
 * ========================= */
function renderItemMode(){
  const panel = document.getElementById("itemModePanel");
  const sel = document.getElementById("itemGroupSelect");
  const list = document.getElementById("itemList");
  panel.style.display = "block";
  list.innerHTML = "";

  if(state.roster.length===0){
    list.innerHTML = `<div class="muted">名簿を入力してください。</div>`;
    return;
  }

  const lessonKey = state.currentLessonKey;
  const groups = getLessonGroups(lessonKey);

  sel.innerHTML = groups.map(g=>{
    const dom = CONFIG.domains[g.domain];
    return `<option value="${escapeHtml(g.id)}">${escapeHtml(dom.label)}｜${escapeHtml(g.title)}</option>`;
  }).join("");

  if(!state.currentItemGroupId || !groups.find(g=>g.id===state.currentItemGroupId)){
    state.currentItemGroupId = groups[0]?.id || "";
  }
  sel.value = state.currentItemGroupId;

  const group = groups.find(g=>g.id===state.currentItemGroupId);
  if(!group){
    list.innerHTML = `<div class="muted">項目がありません。</div>`;
    return;
  }

  for(const st of state.roster){
    const rec = ensureGroup(st.id, lessonKey, group.id);

    const row = document.createElement("div");
    row.className = "itemRow";

    const left = document.createElement("div");
    left.style.minWidth="220px";
    left.style.flex="1";
    left.innerHTML = `
      <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
        <b>${escapeHtml(st.name)}</b>
        <span class="tag ${group.domain==="K"?"k":group.domain==="T"?"t":"a"}">${escapeHtml(CONFIG.domains[group.domain].label)}</span>
        <span class="tag gray">${group.scoring.max}点</span>
      </div>
      <div class="mini">${escapeHtml(group.title)}</div>
    `;

    const right = document.createElement("div");
    right.style.display="flex";
    right.style.gap="8px";
    right.style.alignItems="center";
    right.style.flexWrap="wrap";
    right.style.justifyContent="flex-end";

    if(group.scoring.type === "checkCount"){
      const checks = rec.checks || [];
      const max = group.scoring.max;

      const checksWrap = document.createElement("div");
      checksWrap.className = "smallChecks";
      for(let i=0;i<max;i++){
        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.checked = !!checks[i];
        cb.addEventListener("change", ()=>{
          rec.checks = rec.checks || [];
          rec.checks[i] = cb.checked;
          markDirty();
          renderRosterList();
          updateTotalsUI();
        });
        checksWrap.appendChild(cb);
      }
      right.appendChild(checksWrap);

      const cnt = checks.filter(Boolean).length;
      const cntTag = document.createElement("span");
      cntTag.className="tag gray";
      cntTag.textContent = `達成：${cnt}/${max}`;
      right.appendChild(cntTag);
    }else{
      const inp = document.createElement("input");
      inp.className = "input num";
      inp.inputMode = "numeric";
      inp.placeholder = "0";
      inp.value = (rec.score==null) ? "" : rec.score;
      inp.addEventListener("input", ()=>{
        let v = inp.value.replace(/[^\d]/g,"");
        if(v===""){ rec.score=null; markDirty(); renderRosterList(); updateTotalsUI(); return; }
        let n = Number(v);
        if(!Number.isFinite(n)) n=0;
        n = Math.max(0, Math.min(group.scoring.max, n));
        rec.score = n;
        if(String(n)!==inp.value) inp.value = n;
        markDirty();
        renderRosterList();
        updateTotalsUI();
      });
      right.appendChild(inp);
    }

    const detailBtn = document.createElement("button");
    detailBtn.className="btn small";
    detailBtn.type="button";
    detailBtn.textContent="詳細";
    detailBtn.addEventListener("click", ()=>{
      state.uiMode = "student";
      state.currentStudentId = st.id;
      markDirty();
      renderAll();
      showToast("児童モードに切替");
    });
    right.appendChild(detailBtn);

    row.appendChild(left);
    row.appendChild(right);
    list.appendChild(row);
  }
}

/** =========================
 *  8) 注釈（ペン／図形／文字／消しゴム）
 * ========================= */
const modal = document.getElementById("modal");
const baseImg = document.getElementById("baseImg");
const ink = document.getElementById("ink");

const penColor = document.getElementById("penColor");
const penSize = document.getElementById("penSize");
const penSizeVal = document.getElementById("penSizeVal");

let tool = "pen"; // pen | eraser | obj | rect | text | line | arrow | circle | ellipse | tri
let draw = { active:false, startX:0, startY:0, lastX:0, lastY:0 };
let hist = []; // undo stack (ink layer data urls)
let current = { studentId:"", lessonKey:"", groupId:"", photoId:"" };

function setTool(t){
  tool=t;
  const ids = ["toolPen","toolEraser","toolObjEraser","toolLine","toolArrow","toolRect","toolCircle","toolEllipse","toolTri","toolText"];
  for(const id of ids){
    const el = document.getElementById(id);
    if(!el) continue;
    el.classList.remove("primary","warn","danger");
  }
  if(t==="pen") document.getElementById("toolPen").classList.add("primary");
  if(t==="eraser") document.getElementById("toolEraser").classList.add("warn");
  if(t==="obj") document.getElementById("toolObjEraser").classList.add("danger");
  if(["line","arrow","rect","circle","ellipse","tri","text"].includes(t)){
    const map = {line:"toolLine",arrow:"toolArrow",rect:"toolRect",circle:"toolCircle",ellipse:"toolEllipse",tri:"toolTri",text:"toolText"};
    document.getElementById(map[t]).classList.add("primary");
  }
}

function fitCanvasToImage(){
  const w = baseImg.naturalWidth;
  const h = baseImg.naturalHeight;
  ink.width = w;
  ink.height = h;
  ink.style.width = baseImg.clientWidth + "px";
  ink.style.height = baseImg.clientHeight + "px";
}
function syncCanvasCss(){
  ink.style.width = baseImg.clientWidth + "px";
  ink.style.height = baseImg.clientHeight + "px";
}
window.addEventListener("resize", ()=> {
  if(modal.classList.contains("show")){
    syncCanvasCss();
  }
});

function getPhotoRef(studentId, lessonKey, groupId, photoId){
  const rec = ensureGroup(studentId, lessonKey, groupId);
  return (rec.photos||[]).find(p=>p.id===photoId);
}

function pushUndo(){
  hist.push(ink.toDataURL("image/png"));
  if(hist.length>30) hist.shift();
}
function loadInkFromDataUrl(dataUrl){
  const ctx = ink.getContext("2d");
  ctx.clearRect(0,0,ink.width, ink.height);
  if(!dataUrl) return;
  const img = new Image();
  img.onload = ()=> ctx.drawImage(img,0,0,ink.width, ink.height);
  img.src = dataUrl;
}

function drawLine(ctx, x1,y1,x2,y2, color, size, mode="source-over"){
  ctx.save();
  ctx.globalCompositeOperation = mode;
  ctx.strokeStyle = color;
  ctx.lineWidth = size;
  ctx.lineCap = "round";
  ctx.lineJoin = "round";
  ctx.beginPath();
  ctx.moveTo(x1,y1);
  ctx.lineTo(x2,y2);
  ctx.stroke();
  ctx.restore();
}
function drawRect(ctx, x1,y1,x2,y2, color, size){
  ctx.save();
  ctx.strokeStyle=color;
  ctx.lineWidth=size;
  ctx.beginPath();
  ctx.rect(x1,y1,(x2-x1),(y2-y1));
  ctx.stroke();
  ctx.restore();
}
function drawLineSeg(ctx, x1,y1,x2,y2, color, size){
  drawLine(ctx, x1,y1,x2,y2, color, size, "source-over");
}
function drawArrow(ctx, x1,y1,x2,y2, color, size){
  drawLineSeg(ctx, x1,y1,x2,y2, color, size);
  const ang = Math.atan2(y2-y1, x2-x1);
  const head = Math.max(10, size*4);
  const a1 = ang + Math.PI*0.85;
  const a2 = ang - Math.PI*0.85;
  ctx.save();
  ctx.strokeStyle=color;
  ctx.lineWidth=size;
  ctx.lineCap="round";
  ctx.beginPath();
  ctx.moveTo(x2,y2);
  ctx.lineTo(x2 + head*Math.cos(a1), y2 + head*Math.sin(a1));
  ctx.moveTo(x2,y2);
  ctx.lineTo(x2 + head*Math.cos(a2), y2 + head*Math.sin(a2));
  ctx.stroke();
  ctx.restore();
}
function drawEllipse(ctx, x1,y1,x2,y2, color, size){
  const cx = (x1+x2)/2, cy=(y1+y2)/2;
  const rx = Math.abs(x2-x1)/2, ry=Math.abs(y2-y1)/2;
  ctx.save();
  ctx.strokeStyle=color;
  ctx.lineWidth=size;
  ctx.beginPath();
  ctx.ellipse(cx, cy, Math.max(1,rx), Math.max(1,ry), 0, 0, Math.PI*2);
  ctx.stroke();
  ctx.restore();
}
function drawTriangle(ctx, x1,y1,x2,y2, color, size){
  const topY = Math.min(y1,y2);
  const botY = Math.max(y1,y2);
  const leftX = Math.min(x1,x2);
  const rightX = Math.max(x1,x2);
  const cx = (leftX+rightX)/2;
  ctx.save();
  ctx.strokeStyle=color;
  ctx.lineWidth=size;
  ctx.beginPath();
  ctx.moveTo(cx, topY);
  ctx.lineTo(rightX, botY);
  ctx.lineTo(leftX, botY);
  ctx.closePath();
  ctx.stroke();
  ctx.restore();
}
function putTextAt(ctx, x,y, text, color, size){
  ctx.save();
  ctx.fillStyle=color;
  ctx.font = `${Math.max(12, size*3)}px ui-sans-serif, system-ui, -apple-system, "Hiragino Sans", "Noto Sans JP"`;
  ctx.fillText(text, x, y);
  ctx.restore();
}

async function openAnnotator(studentId, lessonKey, groupId, photoId){
  const p = getPhotoRef(studentId, lessonKey, groupId, photoId);
  if(!p) return;

  current = {studentId, lessonKey, groupId, photoId};
  document.getElementById("modalTitle").textContent = "写真注釈";
  document.getElementById("modalSub").textContent = `${studentNameById(studentId)}｜${lessonNameByKey(lessonKey)}`;

  hist = [];
  setTool("pen");
  penSizeVal.textContent = penSize.value;

  baseImg.onload = ()=>{
    setTimeout(()=>{
      fitCanvasToImage();
      loadInkFromDataUrl(p.inkLayer || null);
      syncCanvasCss();
    }, 0);
  };
  baseImg.src = p.baseDataUrl;

  modal.classList.add("show");
}
function closeAnnotator(){
  modal.classList.remove("show");
  current = { studentId:"", lessonKey:"", groupId:"", photoId:"" };
}

function canvasPoint(e){
  const rect = ink.getBoundingClientRect();
  const sx = ink.width / rect.width;
  const sy = ink.height / rect.height;
  const x = (e.clientX - rect.left) * sx;
  const y = (e.clientY - rect.top) * sy;
  return {x, y};
}

ink.addEventListener("pointerdown", (e)=>{
  e.preventDefault();
  if(!modal.classList.contains("show")) return;
  ink.setPointerCapture(e.pointerId);

  const ctx = ink.getContext("2d");
  const {x,y} = canvasPoint(e);

  if(tool==="obj"){
    pushUndo();
    ctx.save();
    ctx.globalCompositeOperation="destination-out";
    ctx.beginPath();
    ctx.arc(x,y, 22, 0, Math.PI*2);
    ctx.fill();
    ctx.restore();
    markDirty();
    return;
  }

  draw.active=true;
  draw.startX=x; draw.startY=y;
  draw.lastX=x; draw.lastY=y;

  if(tool==="pen" || tool==="eraser"){
    pushUndo();
    drawLine(ctx, x,y,x,y, penColor.value, Number(penSize.value),
      tool==="eraser" ? "destination-out" : "source-over"
    );
  }else if(["rect","line","arrow","circle","ellipse","tri"].includes(tool)){
    pushUndo();
  }
});

ink.addEventListener("pointermove", (e)=>{
  if(!draw.active) return;
  e.preventDefault();
  const ctx = ink.getContext("2d");
  const {x,y} = canvasPoint(e);

  if(tool==="pen" || tool==="eraser"){
    drawLine(ctx, draw.lastX, draw.lastY, x, y, penColor.value, Number(penSize.value),
      tool==="eraser" ? "destination-out" : "source-over"
    );
    draw.lastX=x; draw.lastY=y;
  }else if(["rect","line","arrow","circle","ellipse","tri"].includes(tool)){
    const last = hist[hist.length-1];
    if(last){
      loadInkFromDataUrl(last);
      setTimeout(()=>{
        const ctx2 = ink.getContext("2d");
        const c = penColor.value;
        const s = Number(penSize.value);

        if(tool==="rect") drawRect(ctx2, draw.startX, draw.startY, x, y, c, s);
        if(tool==="line") drawLineSeg(ctx2, draw.startX, draw.startY, x, y, c, s);
        if(tool==="arrow") drawArrow(ctx2, draw.startX, draw.startY, x, y, c, s);

        if(tool==="circle"){
          const dx = x - draw.startX, dy = y - draw.startY;
          const r = Math.max(Math.abs(dx), Math.abs(dy));
          drawEllipse(
            ctx2,
            draw.startX, draw.startY,
            draw.startX + Math.sign(dx||1)*r,
            draw.startY + Math.sign(dy||1)*r,
            c, s
          );
        }
        if(tool==="ellipse") drawEllipse(ctx2, draw.startX, draw.startY, x, y, c, s);
        if(tool==="tri") drawTriangle(ctx2, draw.startX, draw.startY, x, y, c, s);
      }, 0);
    }
  }
});

ink.addEventListener("pointerup", (e)=>{
  if(!draw.active) return;
  e.preventDefault();
  draw.active=false;
});

ink.addEventListener("click", (e)=>{
  if(!modal.classList.contains("show")) return;
  if(tool!=="text") return;
  const ctx = ink.getContext("2d");
  const {x,y} = canvasPoint(e);
  const text = prompt("挿入する文字（短め）");
  if(text==null) return;
  pushUndo();
  putTextAt(ctx, x, y, text, penColor.value, Number(penSize.value));
  markDirty();
});

function makeThumbFromBaseAndInk(baseDataUrl){
  try{
    const c = document.createElement("canvas");
    c.width = baseImg.naturalWidth;
    c.height = baseImg.naturalHeight;
    const ctx = c.getContext("2d");
    ctx.drawImage(baseImg,0,0,c.width,c.height);
    ctx.drawImage(ink,0,0,c.width,c.height);
    return c.toDataURL("image/jpeg", 0.9);
  }catch{
    return baseDataUrl;
  }
}

document.getElementById("btnUndo").addEventListener("click", ()=>{
  if(hist.length===0){ showToast("戻せる履歴がない"); return; }
  const last = hist.pop();
  loadInkFromDataUrl(last);
  markDirty();
});
document.getElementById("btnClearInk").addEventListener("click", ()=>{
  const ctx = ink.getContext("2d");
  pushUndo();
  ctx.clearRect(0,0,ink.width, ink.height);
  markDirty();
});
document.getElementById("btnSaveInk").addEventListener("click", ()=>{
  const p = getPhotoRef(current.studentId, current.lessonKey, current.groupId, current.photoId);
  if(!p) return;
  p.inkLayer = ink.toDataURL("image/png");
  p.thumbDataUrl = makeThumbFromBaseAndInk(p.baseDataUrl);
  markDirty();
  showToast("注釈を保存した");
  renderAll();
});
document.getElementById("btnClose").addEventListener("click", closeAnnotator);

penSize.addEventListener("input", ()=> penSizeVal.textContent = penSize.value);

document.getElementById("toolPen").addEventListener("click", ()=> setTool("pen"));
document.getElementById("toolEraser").addEventListener("click", ()=> setTool("eraser"));
document.getElementById("toolObjEraser").addEventListener("click", ()=> setTool("obj"));
document.getElementById("toolLine").addEventListener("click", ()=> setTool("line"));
document.getElementById("toolArrow").addEventListener("click", ()=> setTool("arrow"));
document.getElementById("toolRect").addEventListener("click", ()=> setTool("rect"));
document.getElementById("toolCircle").addEventListener("click", ()=> setTool("circle"));
document.getElementById("toolEllipse").addEventListener("click", ()=> setTool("ellipse"));
document.getElementById("toolTri").addEventListener("click", ()=> setTool("tri"));
document.getElementById("toolText").addEventListener("click", ()=> setTool("text"));

/** =========================
 *  9) 写真追加（iPad Safariで確実に開く）
 * ========================= */
document.addEventListener("click", (e)=>{
  const t = e.target;
  const openBtn = t.closest("button[data-open-picker='1']");
  if(openBtn){
    const input = openBtn.parentElement.querySelector("input[type='file'][data-photoadd='1']");
    if(!input){
      showToast("写真入力が見つからない…");
      return;
    }
    input.click();
  }
});

document.addEventListener("change", async (e)=>{
  const input = e.target;
  if(!(input instanceof HTMLInputElement)) return;
  if(input.getAttribute("data-photoadd")!=="1") return;

  const sid = input.dataset.student;
  const lkey = input.dataset.lesson;
  const gid = input.dataset.group;

  const files = Array.from(input.files || []);
  if(files.length===0) return;

  const rec = ensureGroup(sid, lkey, gid);
  for(const f of files){
    const dataUrl = await fileToDataUrl(f);
    rec.photos = rec.photos || [];
    rec.photos.push({
      id: makeId("ph"),
      baseDataUrl: dataUrl,
      inkLayer: null,
      thumbDataUrl: null,
      createdAt: nowISO(),
    });
  }

  input.value = "";
  markDirty();
  renderAll();
  showToast(`${files.length}枚 追加した`);
});

/** =========================
 *  10) 入力イベント（点数・チェック・メモ）
 * ========================= */
document.addEventListener("input", (e)=>{
  const sid = state.currentStudentId;
  const lessonKey = state.currentLessonKey;
  const t = e.target;

  if(t.id==="unitName"){
    state.meta.unitName = t.value || "";
    document.getElementById("subTitle").textContent = `単元：${state.meta.unitName || "—"}｜端末内に自動保存`;
    markDirty();
    return;
  }

  if(t.id==="overallMemo"){
    if(!sid) return;
    const lesson = ensurePath(sid, lessonKey);
    if(!lesson.__overall) lesson.__overall = { memo:"" };
    lesson.__overall.memo = t.value || "";
    markDirty();
    return;
  }

  if(t instanceof HTMLInputElement && t.getAttribute("data-score")==="1"){
    if(!sid) return;
    const gid = t.dataset.group;
    const groups = getLessonGroups(lessonKey);
    const g = groups.find(x=>x.id===gid);
    if(!g) return;

    const rec = ensureGroup(sid, lessonKey, gid);
    let v = t.value.replace(/[^\d]/g,"");
    if(v===""){ rec.score=null; markDirty(); updateTotalsUI(); renderRosterList(); return; }
    let n = Number(v);
    if(!Number.isFinite(n)) n=0;
    n = Math.max(0, Math.min(g.scoring.max, n));
    rec.score = n;
    if(String(n)!==t.value) t.value = n;

    markDirty();
    updateTotalsUI();
    renderRosterList();
    return;
  }

  if(t instanceof HTMLTextAreaElement && t.getAttribute("data-memo")==="1"){
    if(!sid) return;
    const gid = t.dataset.group;
    const rec = ensureGroup(sid, lessonKey, gid);
    rec.memo = t.value || "";
    markDirty();
    return;
  }
});

document.addEventListener("change", (e)=>{
  const t = e.target;

  if(t.id==="lessonKey"){
    state.currentLessonKey = t.value;
    // 項目モードの選択もリセット
    state.currentItemGroupId = "";
    markDirty();
    renderAll();
    return;
  }

  if(t.id==="itemGroupSelect"){
    state.currentItemGroupId = t.value;
    markDirty();
    renderAll();
    return;
  }

  const sid = state.currentStudentId;
  if(!sid) return;

  const lessonKey = state.currentLessonKey;

  if(t instanceof HTMLInputElement && t.getAttribute("data-check")==="1"){
    const gid = t.dataset.group;
    const idx = Number(t.dataset.idx);
    const rec = ensureGroup(sid, lessonKey, gid);
    rec.checks = rec.checks || [];
    rec.checks[idx] = t.checked;

    markDirty();
    updateTotalsUI();
    renderRosterList();
    renderRubric();
    return;
  }
});

/** =========================
 *  11) ナビ・名簿反映
 * ========================= */
document.getElementById("btnApplyRoster").addEventListener("click", ()=>{
  const text = document.getElementById("rosterText").value || "";
  const lines = text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  const roster = lines.map(name=>({ id: makeId("st"), name }));
  state.roster = roster;
  if(!state.currentStudentId && roster.length>0) state.currentStudentId = roster[0].id;
  markDirty();
  renderAll();
  showToast("名簿を反映した");
});

document.getElementById("btnPrev").addEventListener("click", ()=>{
  if(state.roster.length===0) return;
  const idx = state.roster.findIndex(s=>s.id===state.currentStudentId);
  const n = (idx<=0) ? state.roster.length-1 : idx-1;
  state.currentStudentId = state.roster[n].id;
  markDirty();
  renderAll();
});
document.getElementById("btnNext").addEventListener("click", ()=>{
  if(state.roster.length===0) return;
  const idx = state.roster.findIndex(s=>s.id===state.currentStudentId);
  const n = (idx<0 || idx===state.roster.length-1) ? 0 : idx+1;
  state.currentStudentId = state.roster[n].id;
  markDirty();
  renderAll();
});

/** 表示モード切替 */
document.getElementById("btnMode").addEventListener("click", ()=>{
  state.uiMode = (state.uiMode === "student") ? "item" : "student";
  markDirty();
  renderAll();
});

/** =========================
 *  12) バックアップ／復元／全消去
 * ========================= */
document.getElementById("btnBackup").addEventListener("click", ()=>{
  const blob = new Blob([JSON.stringify(state,null,2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `sci_eval_backup_${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  URL.revokeObjectURL(a.href);
  showToast("バックアップを書き出した");
});

document.getElementById("btnRestore").addEventListener("click", ()=>{
  const input = document.createElement("input");
  input.type="file";
  input.accept="application/json";
  input.onchange = async ()=>{
    const f = input.files?.[0];
    if(!f) return;
    const text = await f.text();
    try{
      const obj = JSON.parse(text);
      if(!obj || typeof obj !== "object") throw new Error("invalid");
      state = obj;
      if(!state.currentLessonKey) state.currentLessonKey = CONFIG.lessons[0].key;
      if(!state.uiMode) state.uiMode = "student";
      if(!state.currentItemGroupId) state.currentItemGroupId = "";
      markDirty();
      renderAll();
      showToast("復元した");
    }catch{
      showToast("復元に失敗（JSONが不正）");
    }
  };
  input.click();
});

document.getElementById("btnReset").addEventListener("click", async ()=>{
  if(!confirm("端末内の記録をすべて消します。よろしいですか？")) return;
  await idbDel(STATE_KEY);
  state = {
    meta:{ unitName: CONFIG.unitDefault, updatedAt: nowISO() },
    roster: [],
    currentStudentId: "",
    currentLessonKey: CONFIG.lessons[0].key,
    uiMode:"student",
    currentItemGroupId:"",
    records: {},
  };
  renderAll();
  showToast("全消去しました");
});

/** =========================
 *  13) 画面更新
 * ========================= */
function updateTotalsUI(){
  const sid = state.currentStudentId;
  if(!sid){
    document.getElementById("sumK").textContent="0";
    document.getElementById("sumT").textContent="0";
    document.getElementById("sumA").textContent="0";
    document.getElementById("sumAll").textContent="0";
    document.getElementById("gradeAll").textContent="—";
    document.getElementById("gradeAll").className="grade B";
    document.getElementById("who").textContent="—";
    return;
  }

  const totals = calcTotals(sid, state.currentLessonKey);
  document.getElementById("sumK").textContent = totals.sumK;
  document.getElementById("sumT").textContent = totals.sumT;
  document.getElementById("sumA").textContent = totals.sumA;
  document.getElementById("sumAll").textContent = `${totals.sumAll}/${totals.maxAll}`;
  const g = document.getElementById("gradeAll");
  g.textContent = totals.grade;
  g.className = "grade " + gradeClass(totals.grade);

  document.getElementById("who").textContent = `${studentNameById(sid)}｜${lessonNameByKey(state.currentLessonKey)}`;
}

function renderAll(){
  document.getElementById("unitName").value = state.meta.unitName || "";
  document.getElementById("subTitle").textContent = `単元：${state.meta.unitName || "—"}｜端末内に自動保存`;

  renderLessonSelect();

  // overall memo
  const sid = state.currentStudentId;
  if(sid){
    const lesson = ensurePath(sid, state.currentLessonKey);
    const memo = lesson.__overall?.memo || "";
    document.getElementById("overallMemo").value = memo;
  }else{
    document.getElementById("overallMemo").value = "";
  }

  renderRosterList();

  // mode UI
  const btnMode = document.getElementById("btnMode");
  btnMode.textContent = (state.uiMode==="student") ? "表示：児童" : "表示：項目";

  document.getElementById("itemModePanel").style.display = (state.uiMode==="item") ? "block" : "none";
  document.getElementById("rubric").style.display = (state.uiMode==="student") ? "block" : "none";

  if(state.uiMode==="student"){
    renderRubric();
  }else{
    renderItemMode();
  }

  updateTotalsUI();
}

/** =========================
 *  14) 起動
 * ========================= */
(async function init(){
  await openDB();
  const saved = await idbGet(STATE_KEY);
  if(saved){
    state = saved;
    if(!state.currentLessonKey) state.currentLessonKey = CONFIG.lessons[0].key;
    if(!state.uiMode) state.uiMode = "student";
    if(!state.currentItemGroupId) state.currentItemGroupId = "";
  }else{
    // 初回サンプル
    state.roster = [
      {id:makeId("st"), name:"3年A 児童A"},
      {id:makeId("st"), name:"3年A 児童B"},
    ];
    state.currentStudentId = state.roster[0].id;
    state.meta.unitName = CONFIG.unitDefault;
    await idbSet(STATE_KEY, state);
  }

  document.getElementById("rosterText").value = state.roster.map(s=>s.name).join("\n");
  renderAll();
  showToast("起動しました");
})();
</script>
</body>
</html>
